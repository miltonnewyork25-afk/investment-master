---
name: phase-gate-validator
description: Phase质量门控自动验证 v2.0。v2.0新增Mermaid图检查(数量+类型多样性)+跨报告回归对比(No Regression铁律F)。替代手动逐项核对QG-01~QG-12。适用于每个Phase完成时。
---

# Phase 质量门控验证技能 v2.0

> v2.0 升级: 新增 Mermaid 图检查 + 回归对比(铁律F)
> 来源: COST v21 QG-01~QG-12 手动核对经验 + COST Mermaid缺口反思
> 规范依据: `docs/readability_spec.md` v22.0

## 触发条件

- 每个 Phase 完成时（必须触发，完整模式）
- Phase 内单个 Agent 完成时（建议触发，快速模式）
- Phase 5 完成后（必须触发，回归模式）

## 三种模式

| 模式 | 检查范围 | 耗时 | 触发时机 |
|------|---------|------|---------|
| **快速模式** | 单Agent产出 — 字符/标注/硬数据 | <1分钟 | Agent完成后 |
| **完整模式** | 整个Phase — 全部门控项+Mermaid检查 | 3-5分钟 | Phase完成后 |
| **回归模式** | 全报告 vs 上一份报告 — 10项回归指标 | 5-10分钟 | Phase 5完成后 |

---

## 快速模式 (Agent级)

对单个Agent产出文件检查：

```markdown
## Agent {ID} 快速检查
- 文件: {文件名}
- 字符数: {N} (目标: {下限}-{上限}) → ✅/❌
- 标注数: {N} (密度: {N}/万字符, 目标: ≥15) → ✅/❌
- 硬数据占比: {N}% (目标: ≥40%) → ✅/❌
- CQ关联: {列出关联的CQ} → ✅/❌
- 数据锚点引用: {N}个 → ✅/❌
- 自检声明: 有/无 → ✅/❌
```

**不通过处理**: 通知主线程，标记问题项，Agent修正后重新检查。

---

## 完整模式 (Phase级)

### 通用门控项 (所有Phase适用)

| # | 门控项 | 检查方法 | 通过标准 |
|---|--------|---------|---------|
| G-01 | 总字符数 | `wc -m` | ≥Phase目标字符 |
| G-02 | 标注密度 | 计数 `[硬数据:]` `[合理推断:]` `[主观判断:]` | ≥15个/万字符 |
| G-03 | 硬数据占比 | 硬数据标注数 / 总标注数 | ≥40% |
| G-04 | 数据锚点引用 | 搜索 `DA-` 引用 | 每Agent ≥3个 |
| G-05 | 无源数字 | 搜索未标注的关键数字 | 0个无源数字 |
| G-06 | CQ覆盖 | 检查本Phase应覆盖的CQ | 100%覆盖 |
| G-07 | 表格数量 | 计数markdown表格 | ≥Phase目标 |
| **G-08** | **Mermaid图数量** | 计数 ` ```mermaid ` 代码块 | ≥Phase必选数(见下表) |
| **G-09** | **Mermaid图类型** | 识别 graph/pie/gantt/radar/quadrantChart | 全报告累计 ≥4种 |
| **G-10** | **Mermaid必选覆盖** | 对照必选清单 M-01~M-10 | Phase内必选图全部存在 |

### Mermaid必选数 (按Phase)

| Phase | 必选图 | 编号 | 最低张数 |
|-------|--------|------|---------|
| 1 | 产业链全景 + 飞轮 | M-01, M-02 | 2 |
| 2 | 收入构成 + 估值汇总 | M-03, M-04 | 2 |
| 3 | 护城河雷达 + 竞争定位 + 五引擎雷达 | M-05, M-06, M-07 | 3 |
| 4 | Bear Case决策树 | M-08 | 1 |
| 5 | Kill Switch流程 + 催化剂时间线 | M-09, M-10 | 2 |
| **合计** | — | — | **10** |

### Mermaid检查详情

```markdown
## Mermaid图检查

### 数量
- 本Phase Mermaid图: {N}张 (目标: ≥{必选数}) → ✅/❌
- 全报告累计: {N}张 (最终目标: ≥10) → ✅/❌

### 必选清单覆盖
| 编号 | 图名 | 类型 | 存在? |
|------|------|------|:-----:|
| M-01 | 产业链全景图 | graph TD | ✅/❌ |
| M-02 | 飞轮/增长引擎 | graph TD | ✅/❌ |
| M-03 | 收入构成图 | pie | ✅/❌ |
| M-04 | 估值方法论汇总 | graph LR | ✅/❌ |
| M-05 | 护城河雷达 | radar | ✅/❌ |
| M-06 | 竞争定位矩阵 | quadrantChart | ✅/❌ |
| M-07 | 五引擎雷达 | radar | ✅/❌ |
| M-08 | Bear Case决策树 | graph TD | ✅/❌ |
| M-09 | Kill Switch流程 | graph TD | ✅/❌ |
| M-10 | 催化剂时间线 | gantt | ✅/❌ |

### 类型多样性
- 使用类型: {列表} ({N}种)
- 目标: ≥4种 → ✅/❌
- 缺少的类型: {列表}
```

### Phase专用门控项

#### Phase 0+0.5
| # | 门控项 | 通过标准 |
|---|--------|---------|
| QG-P0-01 | 数据文件数 | ≥8个(理想14个) |
| QG-P0-02 | XV交叉验证完成 | CONFLICT全部解决 |
| QG-P0-03 | Core Questions提取 | 5-8个CQ + 注意力分排序 |
| QG-P0-04 | 执行计划生成 | Phase 1-5 Agent设计完成 |

#### Phase 1: 定位与生态
| # | 门控项 | 通过标准 |
|---|--------|---------|
| QG-01 | 公司画像完整 | 业务模型+管理层+历史≥3,000字 |
| QG-02 | 产业链映射 | ≥10个关键节点 |
| QG-03 | 预测市场数据 | ≥8个相关事件 |

#### Phase 2: 财务与估值
| # | 门控项 | 通过标准 |
|---|--------|---------|
| QG-04 | 周期定位 | ≥4个支撑信号 |
| QG-05 | SOTP覆盖率 | 覆盖≥90%营收的分部 |
| QG-06 | 估值交叉验证 | SOTP vs DCF偏离<20% |

#### Phase 3: 战略深度
| # | 门控项 | 通过标准 |
|---|--------|---------|
| QG-07 | 护城河量化 | 每种护城河有数据支撑 |
| QG-08 | 五引擎 | 每引擎≥1,500字 |
| QG-09 | 竞争分析 | PPDA≥3个背离(消费品) / 竞对≥3个(其他) |
| QG-09.5 | AI冲击矩阵 | 覆盖≥90%营收分部 |

#### Phase 4: 对抗审查
| # | 门控项 | 通过标准 |
|---|--------|---------|
| QG-10 | 偏差检查 | 四项偏差全部完成+量化修正 |
| QG-11 | 事实核查+反证 | ≥10点核查 + ≥3条反证 |
| QG-11.5 | 看空占比 | 看空内容≥总篇幅30% |

#### Phase 5: 决策输出
| # | 门控项 | 通过标准 |
|---|--------|---------|
| QG-12 | Kill Switch | ≥15条(含≥2个AI相关) |
| QG-12.5 | 可验证预测 | ≥20个+时间锚定 |
| QG-13 | 投资日历 | 90天行动清单完整 |

---

## 回归模式 (铁律F: No Regression)

> Phase 5 完成后必须触发。对比当前报告 vs 同行业上一份报告的 10 项指标。

### 执行步骤

#### Step 1: 确定对比基准

查找同行业上一份 Tier 3 报告:
- 消费品: COST v21 为当前基准
- 科技平台: GOOGL v4 为当前基准
- 如果是同公司迭代: 用上一版本

#### Step 2: 提取指标

对当前报告和基准报告各提取 10 项指标:

```markdown
## 回归对比

### 指标提取
| # | 指标 | 基准报告({TICKER} v{N}) | 当前报告({TICKER} v{N}) | 变化 | 退步? |
|---|------|----------------------|----------------------|------|:-----:|
| R-01 | 总字符 | 148,000 | {N} | {+/-}% | ✅/❌ |
| R-02 | 标注密度(/万) | 47 | {N} | {+/-} | ✅/❌ |
| R-03 | 硬数据占比 | 62.4% | {N}% | {+/-}pp | ✅/❌ |
| R-04 | Mermaid图数 | 7 | {N} | {+/-} | ✅/❌ |
| R-05 | Mermaid类型数 | 3 | {N} | {+/-} | ✅/❌ |
| R-06 | Kill Switch数 | 15 | {N} | {+/-} | ✅/❌ |
| R-07 | 可验证预测数 | 20 | {N} | {+/-} | ✅/❌ |
| R-08 | 数据表格数 | {N} | {N} | {+/-} | ✅/❌ |
| R-09 | Bear Case数 | 8 | {N} | {+/-} | ✅/❌ |
| R-10 | CQ数量 | 7 | {N} | {+/-} | ✅/❌ |
```

#### Step 3: 判定

```
退步项数 = 0-1 → ✅ 通过
退步项数 = 2   → ⚠️ 警告，需书面说明原因
退步项数 ≥ 3   → ❌ 不通过，必须修正
```

退步原因分类:
- **"刻意精简"**: 接受。例如目标字符从150K降到120K但密度更高
- **"遗漏"**: 不接受。必须补充达标后才能标记完成
- **"结构性差异"**: 视情况。例如公司业务简单导致Bear Case自然少于8个，需书面论证

#### Step 4: 输出回归报告

```markdown
# 回归对比报告 (铁律F)

## 对比基准: {TICKER} v{N} ({日期})

## 10项指标
{表格}

## 退步项分析 (如有)
| 退步项 | 基准 | 当前 | 原因分类 | 说明 |
|--------|------|------|---------|------|
| R-04 | 7 | 5 | 遗漏 | 缺少pie和quadrantChart → 需补充 |

## 结论
- 退步项: {N}/10
- **判定: ✅ 通过 / ⚠️ 警告 / ❌ 不通过**
- 修正建议: {如有}
```

---

## 完整模式输出格式

```markdown
# Phase {N} 质量门控报告

## 总览
- Phase: {名称}
- Agent数: {N}
- 总字符: {N} / 目标{N} → {达成率}%
- 通过/总计: {通过数}/{总门控数}
- **结论: ✅ 通过 / ❌ 不通过**

## 通用门控 (G-01~G-10)
| 门控项 | 实际值 | 目标 | 结果 |
|--------|--------|------|:----:|
| G-01 总字符 | {N} | ≥{目标} | ✅ |
| G-02 标注密度 | {N}/万 | ≥15/万 | ✅ |
| G-03 硬数据% | {N}% | ≥40% | ✅ |
| G-08 Mermaid数 | {N} | ≥{必选} | ✅/❌ |
| G-09 Mermaid类型 | {N}种 | ≥4种(全报告) | ✅/❌ |
| G-10 Mermaid必选 | {N}/{必选} | 100% | ✅/❌ |

## Mermaid检查详情
{必选清单覆盖表}

## Phase专用门控
| 门控项 | 实际值 | 目标 | 结果 |
|--------|--------|------|:----:|
| QG-XX | ... | ... | ✅/❌ |

## 各Agent质量
| Agent | 字符 | 标注(密度) | 硬数据% | 锚点 | 通过 |
|-------|------|-----------|---------|------|:----:|
| P{N}-A | ... | ... | ... | ... | ✅ |

## 不通过项修正建议
{仅当有不通过项时输出}
```

---

## 实战基准数据

### COST v21 (消费品基准)

| Phase | 门控总数 | 通过数 | Mermaid(实际/必选) |
|-------|---------|--------|------------------|
| 0+0.5 | 4 | 4 | 0/0 |
| 1 | 3+10通用 | 13 | 4/2 ✅ |
| 2 | 3+10通用 | 13 | 0/2 ❌(缺pie+估值汇总) |
| 3 | 4+10通用 | 14 | 2/3 ❌(缺quadrantChart) |
| 4 | 3+10通用 | 13 | 0/1 ❌(缺Bear Case树) |
| 5 | 3+10通用 | 13 | 1/2 ❌(缺Kill Switch流程) |

**COST v21 Mermaid 回顾**: 7张图中 4张集中在Phase 1，Phase 2/4/5几乎空白。v22.0标准要求均匀分布。
