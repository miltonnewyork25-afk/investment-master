---
name: report-merger
description: 多Agent产出合并为单一报告+跨章节一致性检查。解决COST v21的19个Agent产出手动合并痛点。适用于Tier 3 Phase 5完成后的最终报告组装。
---

# 报告合并与一致性检查技能 v1.0

> 来源: COST v21 合并经验 — 19个Agent产出→1个150K字符报告
> PG 反例: 手动拼接导致跨章节数据矛盾20%

## 触发条件

- Tier 3 所有 Phase 完成后（必须触发）
- 每个 Phase 内多 Agent 产出需合并时（建议触发）

## 核心原则

```
合并 ≠ 简单拼接
合并 = 拼接 + 去重 + 一致性检查 + 交叉引用修复 + 格式统一
```

## 执行流程

### Step 1: 源文件清点

列出所有待合并文件，按 Phase 排序：

```markdown
| Phase | Agent | 文件 | 字符数 | 状态 |
|-------|-------|------|--------|------|
| 1 | P1-A | Phase1_Section_A.md | 6,500 | ✅ QG通过 |
| 1 | P1-B | Phase1_Section_B.md | 7,200 | ✅ QG通过 |
| ... | ... | ... | ... | ... |
| **合计** | **{N}个** | — | **{总字符}** | — |
```

### Step 2: 结构组装

按预定义的报告结构组装章节：

```markdown
# {TICKER} 深度研究报告 v{版本}

## 项目概览 (自动生成)
## 章节导航 (自动生成)
## 核心结论速览 (从Phase 5提取)

---

# Part I: 定位与生态 (Phase 1)
{P1-A + P1-B + P1-C + P1-D}

# Part II: 财务与估值 (Phase 2)
{P2-A + P2-B + P2-C + P2-D}

# Part III: 战略深度 (Phase 3)
{P3-A + P3-B + P3-C + P3-D + P3-E}

# Part IV: 对抗审查 (Phase 4)
{P4-A + P4-B + P4-C}

# Part V: 决策输出 (Phase 5)
{P5-A + P5-B + P5-C}

## Phase完成度汇总 (自动生成)
## 免责声明 (模板)
```

### Step 3: 一致性检查 (关键步骤)

逐项检查以下维度：

#### 3.1 数值一致性

扫描报告中所有出现的关键数值，确认同一指标在不同章节中数值一致：

| 检查项 | 方法 | 典型问题 |
|--------|------|---------|
| 收入/净利/EPS | 全文搜索数字+上下文 | Phase 2用FY2025, Phase 3引用FY2024 |
| 估值(PE/EV) | 搜索所有估值提及 | SOTP=$875, 但结论写$870 |
| 目标价/评级 | 搜索所有价格提及 | Phase 2的目标价和Phase 5不一致 |
| 增速/比率 | 搜索百分比 | 同店增速在不同章节不同 |

```markdown
## 数值一致性检查
| 指标 | Phase 2引用 | Phase 3引用 | Phase 5引用 | 一致? |
|------|-----------|-----------|-----------|:-----:|
| 公允价值 | $839-$912 | $873(SOTP) | $839-$912 | ✅ |
| PE(TTM) | 53.42x | 53.42x | 53.42x | ✅ |
| 续费率 | 92.3% | 92.3% | 92.3% | ✅ |
```

#### 3.2 逻辑一致性

检查不同章节的结论是否存在逻辑矛盾：

| 检查项 | 方法 |
|--------|------|
| 看多论点 vs 看空论点 | Phase 3看多结论是否在Phase 4被有效回应? |
| 估值 vs 评级 | SOTP高估10% → 评级应为HOLD, 不应是BUY |
| 护城河 vs 风险 | 护城河4.3/5但Kill Switch触发 → 需解释 |
| AI冲击 vs 估值调整 | AI分析结论是否反映在估值中? |

#### 3.3 标注一致性

确认全报告标注格式统一：

- [ ] 全部使用v21标注格式: `[硬数据:]` / `[合理推断:]` / `[主观判断:]`
- [ ] 无旧格式残留: `[A:]` / `[B:]` / `[置信度: XX%]`
- [ ] 数据锚点引用格式统一: `[DM-xxx vN.N]`

#### 3.4 交叉引用修复

Agent独立运行时的章节引用(如"见Phase 2分析")需要更新为实际章节编号：

```
"详见Phase 2 SOTP分析" → "详见第6章 SOTP分部估值"
"P3-B发现..." → "五引擎协同分析(第10章)发现..."
```

### Step 4: 去重

识别并合并重复内容：

| 去重类型 | 处理方式 |
|---------|---------|
| 完全重复段落 | 删除后出现的 |
| 部分重复(相似分析) | 保留更详细的版本，删除简略版 |
| 数据表格重复 | 保留带标注的版本 |
| 免责声明重复 | 仅保留末尾一份 |

### Step 5: 格式统一

- [ ] 章节编号连续(1, 2, 3...)
- [ ] Markdown标题层级正确(# → ## → ###)
- [ ] 表格对齐
- [ ] Mermaid图语法正确
- [ ] 代码块语法正确

### Step 6: 元数据生成

在报告头部生成项目概览：

```markdown
> **框架**: v{版本} | **行业**: {行业}
> **数据截止**: {日期} | **股价基准**: ${价格} ({交易所}: {代码})
> **总字符**: ~{N} | **总章节**: {N}章 | **Agent**: {N}个
> **综合评级**: {评级} ({分数}/10) | **公允价值区间**: ${低}-${高} | **五引擎**: {信号}
```

### Step 7: 输出检查清单

```markdown
## 合并检查清单
- [ ] 所有Phase产出已包含
- [ ] 章节编号连续无遗漏
- [ ] 数值一致性: {N}项检查, {N}项通过
- [ ] 逻辑一致性: {N}项检查, {N}项通过
- [ ] 标注格式统一(v21)
- [ ] 交叉引用已修复
- [ ] 去重完成
- [ ] 总字符: {N} (目标: ≥{目标})
- [ ] Mermaid图: {N}张 (目标: ≥5)
- [ ] Kill Switch: {N}个 (目标: ≥15)
- [ ] 可验证预测: {N}个 (目标: ≥20)
```

## COST v21 实战参考

| 指标 | COST 实际值 |
|------|-----------|
| 源文件数 | 25个(20 Section + 5 Phase汇总) |
| 合并后字符 | ~148,000 (目标110,500的134%) |
| 数值不一致修正 | 3处 |
| 去重段落 | 5段 |
| 交叉引用修复 | 12处 |
| 总耗时 | ~30分钟 |
