# 估值与低估检测方法论 v2.0

**版本**: v2.0
**日期**: 2026-01-26
**作者**: Agent 5 - 估值与低估检测引擎

---

## 1. 核心目标

**找出被市场低估但基本面优秀的股票**

估值引擎的设计原则：
1. **多维度验证** - 单一估值方法可能失效，多方法交叉验证提高可靠性
2. **保守假设** - DCF等模型使用保守参数，避免过度乐观
3. **行业适配** - 不同行业使用不同的估值基准和方法
4. **红旗警示** - 自动识别估值陷阱和风险信号

---

## 2. 四大估值方法框架

### 权重分配

| 方法 | 权重 | 原因 |
|------|------|------|
| 相对估值（vs同业） | 30% | 市场定价参照，即时反映行业估值水平 |
| 历史估值（vs自身） | 25% | 反映公司自身估值周期，识别均值回归机会 |
| FCF收益率 | 25% | 真金白银的现金回报，最实在的估值指标 |
| DCF估值 | 20% | 理论内在价值，提供绝对估值锚点 |

**权重设计逻辑**：
- 相对估值权重最高，因为市场定价短期由比较驱动
- FCF收益率权重与历史估值相当，体现"现金为王"原则
- DCF权重较低，因为假设敏感度高，误差范围大

---

## 3. 方法1: 相对估值（与同业比较）

### 核心逻辑

公司估值应与同行业、类似商业模式的公司相当。如果某公司估值显著低于同业，可能存在低估机会。

### 关键指标

| 指标 | 公式 | 适用场景 |
|------|------|----------|
| **P/E TTM** | 市值 / 过去12个月净利润 | 盈利公司通用 |
| **P/E Forward** | 市值 / 预测下年净利润 | 增长型公司 |
| **EV/EBITDA** | 企业价值 / EBITDA | 跨资本结构对比，排除债务影响 |
| **P/FCF** | 市值 / 自由现金流 | 现金流质量好的公司 |
| **P/B** | 市值 / 净资产 | 金融、地产、重资产行业 |
| **PEG** | P/E / EPS增长率 | 成长型公司，平衡估值与增长 |

### 折/溢价计算

```
折/溢价% = (公司指标 - 行业中位数) / 行业中位数 × 100%
```

### 评分规则

| 折/溢价 | 分数 | 解释 |
|---------|------|------|
| >= -20% (20%折价) | 100 | **深度低估** - 显著低于同业 |
| -10% to -20% | 80 | **中度低估** - 低于同业平均 |
| 0% to -10% | 60 | **轻度低估** - 略低于同业 |
| 0% to +10% | 40 | **轻度溢价** - 略高于同业 |
| +10% to +20% | 20 | **中度溢价** - 高于同业平均 |
| > +20% | 0 | **高估** - 显著高于同业 |

### 子指标权重

| 子指标 | 权重 | 说明 |
|--------|------|------|
| P/E vs 行业 | 40% | 最直观的盈利估值 |
| EV/EBITDA vs 行业 | 30% | 排除资本结构差异 |
| P/FCF vs 行业 | 20% | 现金流质量验证 |
| P/B vs 行业 | 10% | 资产基础验证 |

### 行业基准数据

```
行业估值基准 (2026年1月):

| 行业 | PE中位数 | PE 25% | PE 75% | EV/EBITDA | P/FCF | P/B |
|------|----------|--------|--------|-----------|-------|-----|
| Technology | 28.5 | 22.0 | 38.0 | 18.5 | 28.0 | 6.5 |
| Communication Services | 22.0 | 16.0 | 30.0 | 12.5 | 20.0 | 3.5 |
| Consumer Cyclical | 20.0 | 14.0 | 28.0 | 11.0 | 18.0 | 4.0 |
| Consumer Defensive | 22.0 | 18.0 | 26.0 | 14.0 | 22.0 | 5.0 |
| Healthcare | 24.0 | 18.0 | 32.0 | 15.0 | 24.0 | 4.5 |
| Financials | 12.0 | 9.0 | 15.0 | N/A | N/A | 1.3 |
| Industrials | 20.0 | 15.0 | 26.0 | 12.0 | 20.0 | 3.5 |
| Energy | 10.0 | 7.0 | 14.0 | 5.5 | 8.0 | 1.5 |
| Utilities | 18.0 | 14.0 | 22.0 | 11.0 | N/A | 1.8 |
| Real Estate | 35.0 | 25.0 | 50.0 | 18.0 | N/A | 2.0 |
```

### 特殊处理

**金融行业**：
- 不使用EV/EBITDA和P/FCF（业务特性不适用）
- 重点使用P/E和P/B
- P/B权重提升至30%

**REITs**：
- 使用P/FFO替代P/E
- 不使用P/FCF
- 重点关注股息收益率

---

## 4. 方法2: 历史估值对比

### 核心逻辑

如果公司基本面未恶化，但估值低于自身历史中位数，可能存在均值回归机会。

### 方法论

1. **获取5年历史数据**（20个季度）
2. **计算历史估值分布**（最小值、25%、中位数、75%、最大值）
3. **确定当前估值在历史分布中的百分位**
4. **低百分位 = 低估信号**

### 百分位评分规则

```
评分 = 100 - 当前百分位

示例:
- 当前PE在5年历史中处于第20百分位 → 评分 = 80
- 当前PE在5年历史中处于第50百分位 → 评分 = 50
- 当前PE在5年历史中处于第85百分位 → 评分 = 15
```

### 解释指南

| 百分位 | 解释 | 信号强度 |
|--------|------|----------|
| < 25% | **强烈低估信号** - 处于5年最低四分位 | Strong |
| 25% - 50% | **中度低估信号** - 低于历史中位数 | Moderate |
| 50% - 75% | **估值偏高** - 高于历史中位数 | Weak |
| > 75% | **接近历史高点** - 谨慎 | Avoid |

### 数据质量要求

- 最少需要4个季度的有效数据
- 过滤异常值（PE > 200, P/B > 50）
- 排除负PE期间
- 数据点不足时给中间分（50分）

### 注意事项

**历史估值可能失效的情况**：
1. 商业模式发生根本变化
2. 行业整体重估（如云计算行业PE中枢上移）
3. 公司增长阶段变化（从高增长转为稳定期）
4. 宏观环境剧变（利率大幅变化）

**解决方案**：结合其他估值方法交叉验证，不单独依赖历史估值。

---

## 5. 方法3: FCF收益率估值

### 核心逻辑

**FCF收益率 = 自由现金流 / 市值**

这是投资者以当前价格买入公司100%股权后，每年能获得的现金回报率。

### 计算公式

```
FCF Yield = FCF TTM / Market Cap
FCF per Share = FCF TTM / Shares Outstanding
```

### 评分规则

| FCF收益率 | 分数 | 解释 |
|-----------|------|------|
| > 10% | 100 | **极具吸引力** - 极高现金回报 |
| 7% - 10% | 80 | **有吸引力** - 高于合理回报 |
| 5% - 7% | 60 | **合理** - 提供适当风险溢价 |
| 3% - 5% | 40 | **偏低** - 低于合理回报 |
| 0% - 3% | 20 | **缺乏吸引力** - 低于无风险利率 |
| < 0% (负数) | 0 | **不适用** - 无正现金流 |

### 基准参照

```
2026年1月市场参数:
- 10年期美债收益率: ~4.5%
- 权益风险溢价: ~5.0%
- 合理FCF收益率门槛: 4.5% + 5.0% = 9.5%

标普500平均FCF收益率: ~4.2%
```

### 理论基础

```
投资者要求的回报 = 无风险利率 + 权益风险溢价
                 = 4.5% + 5.0%
                 = 9.5%

FCF Yield > 9.5% → 估值有吸引力
FCF Yield < 4.5% → 低于无风险利率，需要增长预期补偿
```

### 优势

1. **真金白银** - FCF是实际现金，不受会计处理影响
2. **可与债券对比** - 直接与国债收益率比较
3. **简单直观** - 容易理解和计算

### 局限性

1. **不适用于负FCF公司** - 高增长期公司可能FCF为负
2. **资本密集型行业偏低** - 高capex导致FCF偏低
3. **周期性影响** - 周期高点FCF可能虚高

---

## 6. 方法4: 简化DCF估值

### 核心逻辑

通过预测未来现金流并折现，计算公司内在价值。

### 模型结构

```
内在价值 = PV(5年显式期现金流) + PV(终值)

企业价值 = Σ[FCF_t / (1+WACC)^t] + Terminal Value / (1+WACC)^5

股权价值 = 企业价值 - 净债务

每股内在价值 = 股权价值 / 流通股数
```

### 保守假设原则

| 参数 | 保守假设 | 原因 |
|------|----------|------|
| 增长率 | min(历史增长, 分析师预期, 10%) | 取最小值避免过度乐观 |
| 增长率下限 | 2% | 避免负增长假设 |
| 永续增长率 | 2.5% | 低于长期GDP增速 |
| 折现率 | 行业WACC或10% | 使用行业标准 |

### 行业WACC参考

| 行业 | WACC | 说明 |
|------|------|------|
| Technology | 9.5% | Beta较高 |
| Communication Services | 9.0% | 中等Beta |
| Consumer Cyclical | 10.0% | 周期性溢价 |
| Consumer Defensive | 8.2% | 低Beta防守型 |
| Healthcare | 8.8% | 中等波动 |
| Financials | 8.5% | 监管行业 |
| Industrials | 9.2% | 经济敏感 |
| Energy | 9.2% | 商品价格波动 |
| Utilities | 7.0% | 稳定现金流 |
| Real Estate | 7.5% | 资产支撑 |

### 三情景分析

**Base Case (基准情景)**:
- 增长率: 保守估计
- WACC: 行业标准
- 永续增长: 2.5%

**Bull Case (乐观情景)**:
- 增长率: 基准 × 1.3 (上限15%)
- WACC: 行业标准 - 1%
- 永续增长: 3.0%

**Bear Case (悲观情景)**:
- 增长率: 基准 × 0.6 (下限2%)
- WACC: 行业标准 + 1%
- 永续增长: 2.0%

### 安全边际评分

| 上行空间 | 分数 | 解释 |
|----------|------|------|
| > 30% | 100 | **强安全边际** - 显著低于内在价值 |
| 20% - 30% | 80 | **良好安全边际** |
| 10% - 20% | 60 | **适度安全边际** |
| 0% - 10% | 40 | **微弱安全边际** |
| -10% - 0% | 20 | **轻度高估** |
| < -10% | 0-20 | **显著高估** |

### DCF局限性

1. **假设敏感度高** - WACC变化1%可导致估值变化20%+
2. **增长假设难准确** - 5年后的增长率难以预测
3. **不适用于负FCF** - 成长期公司无法使用
4. **忽略战略价值** - 并购溢价、技术期权未反映

---

## 7. 综合评分计算

### 加权公式

```
综合低估评分 =
    相对估值分数 × 30% +
    历史估值分数 × 25% +
    FCF收益率分数 × 25% +
    DCF估值分数 × 20%
```

### 等级划分

| 评分 | 等级 | 信号 | 建议 |
|------|------|------|------|
| >= 80 | A | Strong Buy | 强烈低估，高置信度买入 |
| 65 - 79 | B | Buy | 中度低估，建议买入 |
| 50 - 64 | C | Hold | 轻度低估，观望或持有 |
| < 50 | D | Avoid | 未低估或高估，回避 |

### 投资信号生成

```python
def generate_signal(score, red_flags):
    severe_flags = count_severe_red_flags(red_flags)

    if score >= 75 and severe_flags == 0:
        return 'strong_buy'
    elif score >= 60 and severe_flags <= 1:
        return 'buy'
    elif score >= 45:
        return 'hold'
    else:
        return 'avoid'
```

---

## 8. 红旗警示系统

### 自动检测的红旗

| 红旗 | 触发条件 | 严重程度 |
|------|----------|----------|
| 负FCF | FCF TTM <= 0 | High |
| 极高PE | P/E > 50 | Medium |
| 历史高位 | PE百分位 > 90% | Medium |
| DCF大幅高估 | 上行空间 < -30% | High |
| FCF收益率过低 | 0% < FCF Yield < 2% | Medium |

### 红旗对信号的影响

- **严重红旗 >= 2**: 信号降至最多 'hold'
- **严重红旗 >= 1 + 评分 < 60**: 信号降至 'avoid'

---

## 9. 置信度评估

### 置信度计算

| 条件 | 加分 |
|------|------|
| 相对估值数据完整 (PE + EV/EBITDA均有效) | +1 |
| 历史估值数据充足 (PE百分位有效) | +1 |
| FCF为正 | +1 |
| DCF计算有效 | +1 |

### 置信度等级

| 分数 | 置信度 |
|------|--------|
| 4 | High |
| 2-3 | Medium |
| 0-1 | Low |

---

## 10. 特殊行业处理

### 金融行业 (Banks, Insurance)

- **不使用**: EV/EBITDA, P/FCF, DCF
- **重点使用**: P/E, P/B, 股息收益率
- **特殊指标**: ROE, Net Interest Margin, CET1

### REITs

- **替代指标**: P/FFO 替代 P/E
- **重点关注**: NAV折溢价, Cap Rate, 股息收益率
- **不使用**: 标准DCF

### 科技成长股

- **允许负FCF**: 高增长期正常
- **替代指标**: EV/Sales, Rule of 40
- **估值调整**: 高增长溢价合理

### 周期股 (Energy, Materials)

- **使用周期调整PE**: Shiller PE概念
- **DCF使用保守增长**: 不外推周期高点
- **重点关注**: 成本曲线位置, 资产负债表强度

---

## 11. 使用指南

### 典型工作流

```
1. 获取股票代码列表
2. 运行批量分析: engine.batch_analyze(tickers)
3. 查看排名: 按undervaluation_score降序
4. 筛选:
   - Strong Buy: score >= 75, red_flags = 0
   - Buy: score >= 60, red_flags <= 1
5. 深度研究: 对候选股票进行基本面验证
6. 持续监控: 估值变化追踪
```

### 代码示例

```python
from valuation_engine import UndervaluationEngine

# 初始化引擎
engine = UndervaluationEngine()

# 单股分析
result = engine.analyze('AAPL')
print(f"Score: {result.undervaluation_score}")
print(f"Signal: {result.investment_signal}")

# 批量分析
tickers = ['AAPL', 'MSFT', 'GOOGL', 'META', 'AMZN']
results = engine.batch_analyze(tickers)

# 导出结果
engine.export_results(results, './output')
```

---

## 12. 与其他Agent的集成

### 输入来源

| 来源 | 数据 |
|------|------|
| Agent 1 (Universe) | 股票池、行业分类 |
| Agent 3 (Quality) | 护城河评分、基本面质量 |
| Agent 4 (Risk) | 风险调整因子 |

### 输出去向

| 目标 | 用途 |
|------|------|
| Agent 6 (Ranking) | 估值评分作为排名因子 |
| Agent 8 (Output) | 估值结果纳入最终报告 |

### 集成示例

```python
# 与基本面质量整合
if quality_score >= 70 and undervaluation_score >= 65:
    final_signal = 'strong_buy'  # 质量好 + 估值低 = 最佳候选
```

---

## 13. 数据源与更新频率

### 数据源

| 数据 | 来源 | 更新频率 |
|------|------|----------|
| 实时报价 | FMP API | 实时 (15分钟延迟) |
| 财务报表 | FMP API | 季度报告发布后24小时 |
| 历史估值 | FMP API | 每日更新 |
| 行业基准 | 内置数据 | 季度手动更新 |

### 建议更新频率

| 场景 | 频率 |
|------|------|
| 日常监控 | 每日 |
| 财报季 | 财报发布后立即 |
| 行业基准 | 每季度 |

---

## 14. 已知局限性与改进方向

### 当前局限

1. **行业基准静态** - 需定期手动更新
2. **同业选择有限** - 依赖API返回的peers
3. **DCF假设简化** - 未考虑多阶段增长
4. **ESG未纳入** - 未考虑ESG风险溢价

### 未来改进

1. **动态行业基准** - 实时计算行业估值分布
2. **更精确的WACC** - 基于公司Beta和资本结构
3. **多阶段DCF** - 高增长期 + 稳定期 + 终值
4. **期权定价** - 对有增长期权的公司补充估值

---

**文档版本**: v2.0
**最后更新**: 2026-01-26
**维护者**: Agent 5 - 估值与低估检测引擎
