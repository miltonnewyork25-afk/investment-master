# 反幻觉协议 v2.0

> **v2.0变化**: 验证机制从"自报自审"(内联标注)升级为"外部审计"(DM锚定+脚本验证)。
> Agent仍须遵守5条禁令，但最终验证由 `verify_data_sources.sh` 独立执行。
> **核心思想**: 铁律14"无源数字禁止写入" + 5条禁令 + SOTP规程 + **DM交叉验证(v2.0)**

---

## 设计哲学

**旧模式**: Agent自由推理，数字可以"合理化推算"得出，事后审查很难发现
**新模式**: 数字必须有明确来源（DM锚点/WebSearch/计算公式），无源数字阻断写入

---

## 铁律14: 无源数字禁止写入

> **这是v22.0框架最核心的一条规则**

```
任何出现在报告中的数字，必须满足以下三个条件之一:
  1. 来自Data Master锚点 → 附带 [DM-xxx vN.N]
  2. 来自外部数据源 → 附带 [硬数据: 来源, 日期]
  3. 由明确公式计算得出 → 附带 [合理推断: 计算公式]

不满足以上任一条件的数字 = 幻觉数字 = 禁止写入报告
```

---

## Agent Prompt 反幻觉5条禁令

**每个SubAgent的prompt中必须注入以下5条禁令**:

```markdown
## 反幻觉禁令（必须遵守）

1. **禁止凭记忆引用财务数字** — 所有财务数据必须来自WebSearch获取或
   Data Master锚点，不得凭训练数据中的记忆写入任何营收/利润/增速数字。

2. **禁止"合理推算"替代真实数据** — 不得用"按行业平均""参考同行"等
   模糊推算替代真实数据。如确需推算，必须写出完整计算公式和每个输入值的来源。

3. **禁止编造可比公司倍数** — 估值倍数必须来自至少3家可比公司的真实数据，
   标注来源和日期。不得写"行业一般XX倍"。

4. **禁止虚构预测市场概率** — 预测市场概率只能从Polymarket/Kalshi等平台
   获取。无数据时写"该事件预测市场无覆盖"，不得编造概率数字。

5. **禁止未标注来源的百分比** — 任何百分比（增速、利润率、份额、概率）
   必须标注来源。"约XX%"不是来源，必须写明数字从何而来。
```

---

## SOTP特别规程

> **GOOGL教训**: SOTP段值偏差249%是最严重的幻觉案例。根源是Agent自行推算分部估值而非引用DM锚点。

### 三步验证流程

SOTP估值必须经过三步验证，任一步失败则整个SOTP标记为无效：

```
Step 1: 段值验证
  对每个业务分部:
    ✓ 分部营收来自DM锚点? [DM-FIN-xxx]
    ✓ 分部利润率来自DM锚点或有公式? [DM-FIN-xxx / 计算公式]
    ✓ 估值倍数来自可比公司真实数据? [硬数据: 来源]
    ✓ 分部估值 = 营收 × 倍数 (或利润 × PE)，公式正确?

Step 2: 汇总验证
    ✓ 各分部估值之和 = 报告中的SOTP总估值?
    ✓ 无重复计算? (同一收入未被两个分部各算一次)
    ✓ 无遗漏? (占营收>5%的分部均已估值)
    ✓ 净债务/现金调整正确?

Step 3: 每股验证
    ✓ SOTP总估值 / 稀释后总股数 = 报告中的每股估值?
    ✓ 稀释后总股数来自最新10-K/10-Q? [DM-MKT-xxx]
    ✓ 最终每股估值与其他方法(DCF/可比)偏离度<30%?
```

### SOTP工作底稿模板

```markdown
## SOTP工作底稿 (三步验证)

### Step 1: 段值
| 分部 | 营收来源 | 营收值 | 利润率来源 | 利润率 | 倍数来源 | 倍数 | 段值 |
|------|---------|--------|----------|--------|---------|------|------|
| [A] | [DM-FIN-xxx] | $XXB | [DM-FIN-xxx] | XX% | [3家可比中位数] | XXx | $XXXB |

### Step 2: 汇总
| 项目 | 金额 |
|------|------|
| 分部A | $XXXB |
| 分部B | $XXXB |
| 分部C | $XXXB |
| **分部合计** | **$XXXB** |
| 减: 净债务 | ($XXB) |
| 加: 净现金 | $XXB |
| **企业价值** | **$XXXB** |

### Step 3: 每股
| 项目 | 值 | 来源 |
|------|-----|------|
| 企业价值 | $XXXB | Step 2汇总 |
| 稀释后股数 | X.XXB | [DM-MKT-xxx] |
| **每股估值** | **$XXX.XX** | = 企业价值/股数 |
| DCF每股 | $XXX.XX | 偏离度: X% |
| 可比公司每股 | $XXX.XX | 偏离度: X% |
```

---

## Reviewer专用: 数字一致性检查清单

Phase 4 Reviewer（或Quality Gate R-G检查时）使用以下清单：

```markdown
## 数字一致性检查 (共12项)

### 财务数据一致性 (4项)
□ 1. 报告中所有营收数字 vs DM-FIN系列 → 一致?
□ 2. 报告中所有利润率 vs DM-FIN系列 → 一致?
□ 3. 报告中所有EPS vs DM-FIN系列 → 一致?
□ 4. 年度营收 = 四个季度之和? (如有季度数据)

### 估值数据一致性 (4项)
□ 5. SOTP各分部之和 = 报告中SOTP总值?
□ 6. SOTP每股 = SOTP总值 / 稀释后股数?
□ 7. DCF估值在各引用处的值是否一致?
□ 8. 概率加权估值 = Σ(情景估值 × 概率)?

### 跨章节一致性 (4项)
□ 9. Phase 2估值 vs Phase 5最终估值 → 有解释差异?
□ 10. Kill Switch阈值 vs 估值章节的数字 → 一致?
□ 11. 假设值 vs KAL记录 → 一致?
□ 12. 市场数据(股价/市值) vs DM-MKT系列 → 一致?

结果: 通过 __/12 项
阻断阈值: <10项通过 → 报告退回修改
```

---

## 幻觉高发场景与防范

| 场景 | 幻觉风险 | 防范措施 |
|------|---------|---------|
| 分部估值 | Agent自行推算TAM→份额→收入 | 必须从DM获取分部营收，不得自行推算 |
| 可比公司倍数 | "行业一般20-25倍PE" | 必须列出≥3家可比公司+来源 |
| 增速预测 | "预计增长30%" | 必须标注来源(管理层指引/分析师共识/趋势外推) |
| 预测市场概率 | "Polymarket显示60%" | 必须有WebSearch验证或标注"无覆盖" |
| 历史数据 | 凭记忆引用过去的数字 | 所有历史数据必须WebSearch验证 |
| AI影响量化 | "AI将贡献$10B收入" | 必须标注推理链和每步计算 |

---

## Agent Prompt注入模板

在并行Agent dispatch时，将以下内容注入每个Agent的prompt：

```markdown
## ⚠️ 反幻觉检查点

在你完成分析后，请自行检查以下事项:

1. 统计你的输出中有多少个数字
2. 每个数字旁边是否有来源标注?
3. 是否有"约""大约""估计"等模糊词未附来源?
4. 是否有"行业一般""通常""据了解"等无源表述?

如果发现无源数字，要么补充来源，要么删除该数字并标注"数据待获取"。
```

---

## v2.0: DM交叉验证 (外部审计)

> **核心升级**: 内联标注是AI"自己证明自己没撒谎"，本质不可靠。DM+脚本是外部系统独立验证。

### 三层验证架构

```
Layer 1: DM锚定 (写作时)
  → Agent写报告时，每个数字必须来自DM锚点
  → 铁律14不变: 无DM锚点 = 无源数字 = 禁止写入

Layer 2: 脚本验证 (完成后)
  → verify_data_sources.sh 提取报告中所有关键数字
  → 与DM锚点逐一交叉核对
  → 输出: 覆盖率/一致率/孤儿数字列表

Layer 3: 审计摘要 (报告内)
  → 文末折叠区展示DM覆盖率+锚点数+类型分布
  → 投资者可选择性查看
```

### 脚本检查三项

| 检查项 | 做什么 | 抓什么问题 |
|--------|--------|-----------|
| **DM覆盖率** | 报告关键数字 vs DM锚点 | AI编造的数字在DM里找不到 |
| **数值一致性** | 报告数字 vs DM数值是否匹配 | 张冠李戴、记忆混淆 |
| **DM新鲜度** | 锚点更新日期≤30天 | 用过期数据 |

### 为什么比内联标注更防幻觉

| | 内联标注(v2.0) | DM+脚本(v3.0) |
|---|---|---|
| AI说"来源:X" | 自报自审 — 标注可被编造 | 独立交叉 — 脚本核对DM有没有 |
| 数字正确性 | 标注说对了不代表数字对 | 脚本逐个比对数值 |
| 计算错误 | 标注不检查计算 | DM有基数，可验算衍生值 |
| 覆盖率 | 靠人眼扫有没有漏标 | 脚本100%覆盖 |

---

## 与其他机制的集成

| 机制 | 关系 |
|------|------|
| Data Master (M1) | **核心锚定层**: Agent从DM获取数据，脚本用DM验证报告 |
| KAL (M3) | 假设必须注册到KAL，防止"隐含假设"式幻觉 |
| Kill Switch (M4) | 幻觉检测触发 → Kill Switch "数据可靠性降级" |
| Quality Gate (M6) | R-G中数字一致性检查 + **CG8/CG9审计覆盖检查(v3.0)** |
| verify_data_sources.sh | **v2.0新增**: 独立脚本交叉验证，替代G2标注密度间接检查 |

---

## GOOGL案例回顾

| 问题 | 根因 | 反幻觉协议解决方案 |
|------|------|-------------------|
| Waymo段值$86B→$300B | Agent自行推算TAM×份额 | 铁律14阻断+SOTP三步验证 |
| Writer C"合理化"错误数字 | 无幻觉检测机制 | 5条禁令注入Agent prompt |
| 最终估值跨章节不一致 | 无一致性检查 | 12项数字一致性清单 |

---

## 版本历史

| 版本 | 日期 | 变更 |
|:---:|:---:|------|
| v2.0 | 2026-02-12 | **外部审计升级**: DM交叉验证+verify_data_sources.sh。配合confidence_system v3.0 |
| v1.0 | 2026-02-07 | 初版。铁律14+5条禁令+SOTP三步验证+12项一致性清单 |
