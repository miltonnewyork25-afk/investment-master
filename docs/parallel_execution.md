# 并行Agent协作系统 v3.0

> **v1.0**: 分派-收集（5个Agent并行写→主Agent拼接）
> **v2.0**: 加了锁文件/STATUS.md等管理层（大部分是低价值开销）
> **v3.0**: 砍掉管理仪式，只保留两个真正提升质量的改进
> **设计原则**: 只做能改变输出质量的事

---

## 架构事实（不可改变的约束）

```
主Agent(编排者)
  ├── Writer Agent 1 ──→ 写文件 ──→ 返回     ← 互盲，一次性进程
  ├── Writer Agent 2 ──→ 写文件 ──→ 返回
  ├── Writer Agent 3 ──→ 写文件 ──→ 返回
  ├── ...
  │
  │ [Round 1完成后]
  │
  ├── Reviewer Agent  ──→ 读所有初稿 ──→ 返回问题清单   ← v3.0新增
  │
  │ [主Agent根据review修改]
  │
  └── 最终合并 + commit
```

**底线**: 子Agent是独立进程，不能实时通信，不能互相review。所有协调只能通过文件系统+主Agent中转。

---

## 改进A: 共享上下文文件（解决数据不一致）

### 问题
Phase 3中5个Agent引用同一数据时出现不一致（backlog $155B vs $240B）。
原因：每个Agent独立搜索或从不同数据源取值，没有统一数据锚点。

### 方案

主Agent在启动所有Writer Agent前，生成一个共享上下文文件：

```
data/research/{TICKER}/agent_shared_context.md
```

内容结构（实际示例）：

```markdown
# GOOGL Agent共享上下文

## 数据锚点（所有Agent必须使用这些数字，不要自行搜索替代值）

| 数据项 | 值 | 来源 | 禁止替换 |
|--------|-----|------|:---:|
| 股价 | $331.25 | stock_full.json | ✅ |
| 市值 | $4.02T | stock_full.json | ✅ |
| FY2025收入 | $402.8B | SEC 10-K | ✅ |
| GCP Q4增速 | +48% | SEC Q4 2025 | ✅ |
| GCP利润率 | 30.1% | SEC Q4 2025 | ✅ |
| Cloud backlog | $155B | business_overview.json | ✅ |
| Gemini MAU | 750M | Alphabet Earnings | ✅ |
| 搜索份额(全球) | 90.04% | StatCounter 2026-01 | ✅ |
| Gemini chatbot份额 | 25.2% | SimilarWeb 2026-01 | ✅ |
| SOTP Base | $311/股(无协同),$342(含协同) | Phase 2 | ✅ |
| DCF Base | $319/股 | Phase 2 | ✅ |
| 概率加权估值 | $345/股 | Phase 2 | ✅ |
| 监管折价 | -4.80% | Phase 3 Ch22 | ✅ |
| 护城河评分 | 8.5/10 | Phase 3 Ch19 | ✅ |
| AI能力评分 | 8.75/10 | Phase 3 Ch28 | ✅ |
| AI调整SOTP | $345/股 | Phase 3 Ch29 | ✅ |

## 前序Phase核心结论（≤500字）

[主Agent填入Phase 1-3关键发现的压缩摘要]

## CQ进展

| CQ# | 问题 | 当前回答 | 完成度 |
|-----|------|---------|:---:|
| CQ1 | 搜索能否保住？ | 短期安全(份额90%+Gemini 25%)，中期看AI变现 | 85% |
| ... | ... | ... | ... |

## 禁区清单

| Agent | 负责内容 | 其他Agent不要写 |
|-------|---------|---------------|
| Agent 1 | Ch30 行为偏差 | 不要分析认知偏差 |
| Agent 2 | Ch31 空头分析 | 不要写看空论点 |
| Agent 3 | Ch32 事实核查 | 不要做数据验证 |
```

### 效果
- Agent之间引用的数字保持一致
- 避免同一论点在多个章节重复
- 每个Agent知道自己的边界

---

## 改进B: 两轮迭代（Write→Review→Revise）

### 问题
v1.0/v2.0都是单轮写作——Agent写完就是终稿，没有反馈循环。
研究质量的最大提升来自"写完之后被挑战"，而不是"写的时候更仔细"。

### 方案：三步执行

```
┌─────────────────────────────────────────────────┐
│ Round 1: 并行写作 (Writer Agents)                │
│                                                   │
│   Writer A ──→ Ch30 行为偏差                      │
│   Writer B ──→ Ch31 空头分析                      │
│   Writer C ──→ Ch32-33 事实核查+反论证             │
│                                                   │
│   全部读取 agent_shared_context.md                 │
│   全部写到独立文件                                  │
├─────────────────────────────────────────────────┤
│ Round 2: 交叉审查 (Reviewer Agent)               │
│                                                   │
│   Reviewer ──→ 读所有Round 1输出                  │
│             ──→ 输出结构化问题清单:                 │
│                  - 逻辑漏洞                        │
│                  - 数据不一致                       │
│                  - 遗漏的空头论点                   │
│                  - 过度乐观/悲观的判断              │
│                  - CQ未充分回答的部分               │
├─────────────────────────────────────────────────┤
│ Round 3: 主Agent修改 + 整合                       │
│                                                   │
│   主Agent ──→ 根据review逐项修改                  │
│           ──→ 写P-INT整合章节                     │
│           ──→ git commit                          │
└─────────────────────────────────────────────────┘
```

### Reviewer Agent的prompt模板

```
你是一个投资研究审查员。你的工作是找问题，不是夸奖。

读取以下文件：
- [Round 1所有输出文件路径]
- [agent_shared_context.md路径]

对每个章节输出审查报告：

## 审查清单
1. **数据核实**: 文中引用的数字是否与shared_context一致？列出不一致项。
2. **逻辑漏洞**: 推理链是否有跳跃？结论是否有足够论据支撑？
3. **空头遗漏**: 对于看多论点，是否充分考虑了反面？列出遗漏的空头视角。
4. **过度自信**: 哪些[主观判断]应该降级为"存在争议"？哪些概率估计缺乏依据？
5. **CQ覆盖**: 6个核心问题是否都得到了实质性推进？
6. **重复内容**: 跨章节是否有冗余段落？

输出格式：
| 章节 | 问题类型 | 具体问题 | 建议修改 | 严重度(高/中/低) |

只输出问题清单，不要重写内容。
```

### 预期效果

| 维度 | 单轮(v1.0/v2.0) | 两轮(v3.0) | 改进来源 |
|------|---------|---------|---------|
| 数据一致性 | 偶有矛盾 | 矛盾被发现并修正 | Reviewer交叉检查 |
| 逻辑严密性 | 单一视角 | 弱点被标记 | Reviewer挑战 |
| 空头覆盖 | 可能遗漏 | 遗漏被补充 | Reviewer专项检查 |
| 总体质量 | 一次写完定稿 | 有反馈循环 | +20-30%质量提升 |

---

## 简化后的执行流程

砍掉v2.0中的低价值环节（锁文件、结构化日志、STATUS.md），只保留有用的：

```
Step 0: 生成 agent_shared_context.md
        ↓
Step 1: 启动 N 个 Writer Agent（并行，各自写独立文件）
        ↓
Step 2: 全部完成后，启动 1 个 Reviewer Agent（读所有初稿→输出问题清单）
        ↓
Step 3: 主Agent根据review修改各章节
        ↓
Step 4: 合并为Phase完整文件 + 写P-INT
        ↓
Step 5: git commit + 完成度报告
```

**与v2.0的区别**: 没有锁文件、没有STATUS.md、没有agent_logs/。
这些管理开销在当前架构下不提供真实价值——Agent是一次性进程，不会冲突，不需要锁。

---

## 适用场景

| 场景 | 推荐模式 | 原因 |
|------|---------|------|
| ≤3章、内容简单 | 主Agent直接写 | Agent开销>收益 |
| 4-8章、可并行 | Round 1并行写 + 主Agent合并 | 节省时间，单轮够用 |
| ≥8章 或 需要对抗审查 | **两轮迭代(v3.0)** | 质量提升>时间成本 |
| Phase 4(对抗审查) | **必须两轮** | 空头分析必须被挑战 |

---

## 并行数量限制

```yaml
推荐配置:
  Writer Agent: 3-5个（并行）
  Reviewer Agent: 1个（在Writer全部完成后）
  最大总Agent数: 6个（5 Writer + 1 Reviewer）
```
