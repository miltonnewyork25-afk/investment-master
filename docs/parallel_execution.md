# 并行Agent加速系统 v4.0

> **设计目的**：利用Task Agent能力并行执行独立分析任务，大幅缩短分析时间
> **验证基准**：TSM五引擎并行执行节省约70%时间（从70分钟降至20分钟）
> **v4.0变化**: Agent Prompt反幻觉注入、DM引用规范、Quality Gate v2.0集成

---

## 核心原则

**并行优先原则**：
- 独立任务**必须并行**执行
- 依赖任务**顺序**执行
- 自动识别任务依赖关系
- 最大化时间效率

---

## 可并行任务识别

**适合并行的分析任务**：

| 任务类型 | 并行方式 | 预计节省 | 示例 |
|---------|---------|---------|------|
| **多引擎分析** | 每引擎一个agent | ~70% | 周期+股权+聪明钱+信号+预测市场 |
| **多公司对比** | 每公司一个agent | ~60% | 同行业3-5家公司基础数据收集 |
| **多数据源收集** | 每数据源一个agent | ~50% | 多个财务/行业数据源并行获取 |
| **多维度验证** | 每维度一个agent | ~65% | 技术+周期+AI+地缘四维交叉验证 |
| **多品牌对比** | 每品牌一个agent | ~60% | 消费品多品牌价值+市场份额对比 |

**不适合并行的任务**：
- 有依赖关系的分析步骤（如周期定位→估值计算）
- 需要前序结论的判断（如风险评估→Kill Switch设置）
- 单一简单任务

---

## 自动并行触发规则

**检测到以下情况时自动建议并行**：
```yaml
触发条件:
  - 同时分析多个独立维度
  - 同时处理多家公司
  - 需要从多个数据源收集信息
  - 预估顺序执行>30分钟

自动响应:
  Claude: "检测到可并行任务，建议启动并行分析：

  顺序执行: ~70分钟
  并行执行: ~20分钟 (节省71%)

  确认启动并行？"
```

---

## 执行方式

```yaml
执行方式: 使用 Task tool 同时启动 Explore agents
限制: 最大 3-5 个并行 agent

示例 - 多维度分析:
  Agent 1: "维度A数据收集与分析"
  Agent 2: "维度B数据收集与分析"
  Agent 3: "维度C数据收集与分析"
  主Agent: 汇总对比 → 生成综合分析

结果汇总:
  - 收集各agent输出
  - 交叉验证一致性
  - 识别分歧点
  - 生成综合报告
```

---

## 并行进度监控

**实时状态显示模板**：
```
📊 并行分析进度：

Agent 1 [维度A]   ████████░░ 80%  分析中...
Agent 2 [维度B]   ██████████ 100% ✅ 完成
Agent 3 [维度C]   █████░░░░░ 50%  数据收集中...

⏱️ 已用时间: 12分钟 | 预计剩余: 8分钟
```

---

## 并行数量限制

```yaml
推荐配置:
  最佳并行数: 3-5个agent
  最大并行数: 5个agent
  原因: 过多并行增加协调复杂度，收益递减

资源考虑:
  - 每个agent消耗独立context
  - 需要足够带宽支持并行请求
  - 汇总阶段需要额外处理时间
```

---

## 多Agent协作协议

> 详见 `docs/agent_collaboration_protocol.md`

**解决的5+3个痛点**:
1. 重复I/O → **共享上下文** (`shared_context.md`, Data Master格式)
2. 无质量预检 → **双维度质量门控** P-G(Fast Gate) + R-G(结果检查)
3. 无session恢复 → **任务锁** (`current_tasks/Agent{X}.lock.md`)
4. 无失败记录 → **Agent执行日志** (`agent_logs/`)
5. 批量commit → **增量提交** (每Agent完成即commit)
6. Agent幻觉 (v4.0) → **反幻觉5条禁令**注入每个SubAgent prompt
7. 数据版本混乱 (v4.0) → **DM引用规范** Agent必须用 `[DM-xxx vN.N]` 引用数据
8. 假设不一致 (v4.0) → **KAL引用规范** Agent必须用 `[KA-xxx]` 引用假设

### Agent Prompt v6.0 必须注入项 (v4.0新增)

每个SubAgent dispatch时，prompt中除现有要求外，还必须包含:

1. **反幻觉5条禁令** — 完整文本见 `docs/anti_hallucination_protocol.md` "Agent Prompt 反幻觉5条禁令"
2. **DM引用指令** — "引用数据时必须附带 [DM-xxx vN.N] 标注"
3. **KAL引用指令** — "引用假设时必须附带 [KA-xxx] 标注"
4. **自检清单** — "完成后统计无源数字数量，补充来源或标注'数据待获取'"
