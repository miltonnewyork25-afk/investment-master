# 大项目阶段管理系统

> **设计目的**：解决"部分完成"问题 — 将大项目拆分为可在单次会话内完成的阶段

---

## 核心原则

**单会话专注原则**：
- 每个会话只专注**1个主要目标**
- 大项目必须拆分为**多个独立阶段**
- 每阶段设定**明确的完成标准**
- 阶段完成后才进入下一阶段

---

## 项目规模判断矩阵

| 项目类型 | 预估工作量 | 建议阶段数 | 每阶段时长 |
|---------|-----------|-----------|-----------|
| **简单任务** | <30分钟 | 1阶段 | 单次会话 |
| **中等项目** | 30分钟-2小时 | 2-3阶段 | 每阶段1次会话 |
| **复杂项目** | 2-8小时 | 4-6阶段 | 每阶段专注完成 |
| **大型项目** | >8小时 | 6+阶段 | 跨多日执行 |

---

## 会话启动检查

**每次会话开始时Claude必须**：
1. **检查未完成项目**：是否有进行中的分析
2. **状态报告**：显示当前进度和下一阶段
3. **确认焦点**：明确本次会话的单一目标
4. **时间评估**：估算本阶段是否可在会话内完成

**标准状态报告格式**：
```
📊 项目状态检查：

🔄 进行中项目：[公司名] 深度分析
   ✅ 已完成：Phase 1 技术定位、Phase 2 周期分析
   🎯 当前阶段：Phase 3 - 深度分析
   ⏳ 剩余阶段：Phase 4 决策输出

💡 建议：本次会话专注完成Phase 3
❓ 确认继续？或切换到其他任务？
```

---

## 强制阶段拆分规则

**检测到以下关键词时强制启动阶段规划**：
- "全面升级" / "系统性改进" / "大规模迁移"
- "多个框架" / "所有模块" / "完整实现"
- 任何涉及 >3个文件 或 >5000字符修改 的请求

---

## 阶段完成检查点

**每阶段结束时强制检查**：
```yaml
阶段完成检查清单:
  - [ ] 本阶段所有目标已完成
  - [ ] 产出文件已保存
  - [ ] 质量标准已满足
  - [ ] 下阶段前置条件已就绪

阶段完成报告:
  ✅ 阶段 [N] 完成！
  📝 完成内容：[列表]
  💾 保存位置：[文件路径]

  📌 下一阶段预告：
  - 名称：[阶段N+1名称]
  - 目标：[简述]
  - 建议：下次会话开始时说"继续[公司名]分析"
```

---

## 目标捆绑预防机制

**检测到目标捆绑时自动拆分**：

用户请求："分析NVDA+AMD+INTC全面对比"

Claude响应：
```
⚠️ 检测到多目标请求，建议拆分：

📌 目标1：NVDA深度分析（独立完成）
📌 目标2：AMD深度分析（独立完成）
📌 目标3：INTC深度分析（独立完成）
📌 目标4：三家对比报告（依赖目标1-3）

💡 建议：本次会话专注"NVDA深度分析"
   或使用并行Agent同时收集三家基础数据

❓ 同意拆分？或坚持一次完成？
```

---

## 时间预算保护（v3.0新增）

**Tier 3 Phase时间分配**：

| Phase | 占比 | 说明 |
|-------|------|------|
| Phase 0 数据基础 | 5% | 自动预取 |
| Phase 1 定位生态 | 20% | 公司画像+产业链 |
| Phase 2 财务估值 | 25% | 周期+SOTP+DCF |
| Phase 3 护城河 | 25% | 五引擎+PPDA |
| Phase 4 对抗审查 | 15% | 行为金融+事实核查 |
| Phase 5 决策输出 | 10% | 评级+Kill Switch |

**铁律**: Phase 4+5 合计≥25% 总时间。禁止因前序Phase超时而压缩决策阶段。

---

## 时间感知系统

**会话时长监控**：
- **30分钟标记**：提醒用户检查进度
- **60分钟标记**：建议保存当前工作
- **90分钟标记**：强烈建议结束当前阶段

**时间不足预警**：
```
⏰ 时间提醒：

当前任务预估还需 45 分钟
但检测到可能会话时间有限

建议选项：
1️⃣ 缩小范围，完成核心部分
2️⃣ 保存进度，下次继续
3️⃣ 继续完整执行

❓ 你的选择？
```

---

## 进度持久化

**每次会话结束时自动保存**：
```yaml
保存位置: progress.md (worktree根目录)
内容格式:
  项目名称: [公司名] 深度分析
  最后更新: [时间]
  当前阶段: [Phase N]
  阶段状态: [进行中/已完成]
  下次继续点: [具体位置描述]
  已完成工件: [文件列表]
  待完成事项: [事项列表]
```

**恢复会话时**：
- 自动读取 progress.md
- 显示完整状态报告
- 确认继续点后才执行

---

## 会话效率规则（8条核心）

**规则1 单目标会话** — 每会话只接受1个主目标。多目标→拆分+用户选优先级
**规则2 范围预检** — 任务前估算步骤数+复杂度。>20步必须分Phase
**规则3 文件防错** — 读取前Glob确认存在，始终绝对路径
**规则4 Edit防错** — Edit前必须Read，old_string完全精确匹配
**规则5 大文件分段** — >2000行分段读取，报告按Phase分文件
**规则6 CHANGELOG** — 修改核心文件必须同步更新CHANGELOG.md
**规则7 完成度量化** — 每Phase结束输出完成度报告
**规则8 字符计量** — 统一使用 `wc -m`（Unicode字符），禁止用 `wc -c`（字节）
