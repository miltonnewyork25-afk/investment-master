# 投资大师Agent架构设计原则 v1.0

> 基于Clawdbot设计理念的学习和反思

---

## 来源

通过深入分析Clawdbot Gateway的架构设计，提炼出7个核心洞见，并将其应用于投资分析Agent的设计。

---

## 核心洞见应用

### 洞见1：单点协调者模式

**Clawdbot原理**：Gateway是唯一的消息/工具/状态协调者，所有请求通过统一接口。

**投资大师应用**：
- **Master Framework是唯一入口**：所有投资分析请求通过`master_investment_framework_v1.yaml`
- **统一数据协调**：API调用（FMP/100baggers/SEC）由分析引擎统一管理
- **状态集中管理**：分析状态、进度、结果集中在一处，避免分散

**实现方式**：
```
┌─────────────────────────────────────────────────────┐
│           Master Investment Framework              │
│              (唯一协调者)                           │
├─────────────────────────────────────────────────────┤
│  • 请求路由                                         │
│  • 数据获取协调 (FMP/100baggers/SEC)               │
│  • 分析模块调度                                     │
│  • 状态管理                                         │
│  • 输出格式化                                       │
└─────────────────────────────────────────────────────┘
           │
    ┌──────┴──────┐──────────┐
    │             │          │
分析模块库    数据源API   知识库
```

**好处**：
- 避免多头管理带来的状态不一致
- 便于追踪和调试
- 新功能只需扩展协调者接口

---

### 洞见2：文件即状态

**Clawdbot原理**：用文件存储状态，无需数据库。配置用YAML，日志用JSONL，人类可读。

**投资大师应用**：

| 内容类型 | 存储格式 | 好处 |
|---------|---------|------|
| 投资报告 | Markdown | 人类可读、可Git、易分享 |
| 分析历史 | JSONL | 可追溯、audit trail、易查询 |
| 方法论框架 | YAML | AI可读、可迭代、结构化 |
| 预测追踪 | YAML | 验证闭环、学习积累 |
| 教训库 | YAML | 经验沉淀、持续改进 |

**文件结构**：
```
投资大师/
├── reports/                    # Markdown报告
│   ├── LRCX_Analysis_v1.md
│   └── TSM_Elite_Analysis.md
├── history/                    # JSONL分析历史
│   └── analysis_log.jsonl
├── skills/                     # YAML方法论
│   ├── _common/
│   │   └── master_investment_framework_v1.yaml
│   └── knowledge_base/
│       ├── lessons_learned.yaml
│       └── predictions_tracker.yaml
└── docs/                       # 架构文档
```

**好处**：
- 无需复杂数据库迁移
- Git天然支持版本控制
- 人类和AI都能直接读写
- 灾难恢复简单（文件备份即可）

---

### 洞见3：Context Window管理

**Clawdbot原理**：三层策略管理context - Pruning（修剪）、Compaction（压缩）、Memory Flush（刷新到文件）。

**投资大师应用**：

**优先级规则**（从高到低）：
1. **当前分析的关键数据**（财务指标、竞争格局）- 必须在context
2. **相关公司的历史结论**（之前分析的要点摘要）- 优先加载
3. **方法论框架**（护城河框架、估值模型）- 按需加载
4. **行业背景知识**（产业链位置、市场规模）- 简要摘要
5. **历史分析详情**（完整报告内容）- 仅在需要时获取

**Context预算分配**（以200K token为例）：
```
┌────────────────────────────────────────┐
│ System Prompt + 框架        ~15K (7.5%)│
├────────────────────────────────────────┤
│ 当前公司数据               ~50K (25%) │
├────────────────────────────────────────┤
│ 历史分析摘要               ~20K (10%) │
├────────────────────────────────────────┤
│ 行业背景                   ~15K (7.5%)│
├────────────────────────────────────────┤
│ 留给推理                   ~100K (50%)│
└────────────────────────────────────────┘
```

**实现策略**：
- **Pruning**：移除旧分析的原始数据，保留关键指标和结论
- **Compaction**：历史分析自动生成摘要，存入公司profile
- **Memory Flush**：重要洞见写入`lessons_learned.yaml`

---

### 洞见4：分析Loop设计

**Clawdbot原理**：intake → context → inference → tool → reply → persist 的完整循环。

**投资大师应用**：

```
┌─────────────────────────────────────────────────────────────────┐
│                    投资分析 Loop v1.0                          │
└─────────────────────────────────────────────────────────────────┘

 需求接收      上下文组装       推理        数据获取      报告生成      归档
 (Intake)  →  (Context)   →  (Infer)  →  (Tool)   →  (Reply)  →  (Persist)
    │             │            │           │            │           │
    ▼             ▼            ▼           ▼            ▼           ▼
 解析请求     加载框架      规划路径    调用API      生成报告    保存报告
 验证参数     加载历史      识别数据    验证数据      质量检查    更新历史
 选择分析     检查预算      规划工具    收集信息      格式输出    触发Hook
```

**详见**：`analysis_loop_v1.md`

---

### 洞见5：Session/Project路由

**Clawdbot原理**：不同场景隔离到不同session，避免状态污染。

**投资大师应用**：

| 分析类型 | Session策略 | 说明 |
|---------|------------|------|
| 深度报告 | 独立Session | 一个公司一个session，完整分析 |
| 快速查询 | 共享Session | 简单问答复用session |
| 对比分析 | 专属Session | 多公司对比，独立空间 |
| 行业分析 | 行业Session | 同行业公司共享上下文 |

**隔离原则**：
- 不同公司的深度分析彼此隔离
- 同一公司的追踪分析可共享历史
- 行业级分析可聚合多个公司数据

---

### 洞见6：Hook扩展点

**Clawdbot原理**：生命周期钩子支持扩展，不修改核心逻辑。

**投资大师应用**：

**分析生命周期Hook**：
- `analysis:start` - 分析开始时触发
- `analysis:phase_complete` - 每个Phase完成时
- `analysis:data_collected` - 数据收集完成
- `analysis:report_generated` - 报告生成完成
- `analysis:quality_checked` - 质量检查完成
- `analysis:end` - 分析结束

**应用场景**：
- 分析完成自动通知用户（Telegram/微信）
- 报告自动归档到Git
- 质量不达标自动重试
- 异常数据告警

**详见**：`analysis_hooks_v1.md`

---

### 洞见7：Skill模块化

**Clawdbot原理**：能力模块化，每个skill独立定义，按需加载。

**投资大师应用**：

**Skill组织结构**：
```
skills/
├── _common/                           # 通用框架
│   ├── master_investment_framework_v1.yaml  # 主控框架
│   └── analysis_modules_library_v1.yaml     # 模块库
├── core/                              # 核心能力
│   ├── agent_operating_principles.yaml
│   └── report_quality_standard.yaml
├── valuation_engine/                  # 估值引擎
│   ├── reverse_dcf_v1.yaml
│   └── sotp_v1.yaml
├── knowledge_base/                    # 知识库
│   ├── lessons_learned.yaml
│   └── predictions_tracker.yaml
└── [industry]/                        # 行业专属
    └── semiconductor_framework.yaml
```

**Skill设计原则**：
1. **单一职责**：每个skill只做一件事
2. **独立可测**：skill可以单独验证
3. **版本化**：skill文件带版本号，支持迭代
4. **可组合**：复杂分析由多个skill组合完成

**加载策略**：
- Master Framework定义必须加载的核心skill
- 根据公司类型动态加载行业skill
- 按需加载估值、护城河等专项skill

---

## 架构总览图

```
┌─────────────────────────────────────────────────────────────────────┐
│                      投资大师 Agent 架构                           │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │              Master Investment Framework                     │   │
│  │                  (单点协调者)                                │   │
│  └───────────────────────────┬─────────────────────────────────┘   │
│                              │                                      │
│         ┌────────────────────┼────────────────────┐                │
│         │                    │                    │                │
│         ▼                    ▼                    ▼                │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐          │
│  │ 分析模块库  │     │  数据源API  │     │   知识库    │          │
│  │ (Skills)    │     │ (Tools)     │     │ (Memory)    │          │
│  ├─────────────┤     ├─────────────┤     ├─────────────┤          │
│  │ 护城河分析  │     │ FMP API     │     │ lessons     │          │
│  │ 产品矩阵    │     │ 100baggers  │     │ predictions │          │
│  │ AI产业链   │     │ SEC Filings │     │ company     │          │
│  │ 周期分析    │     │ Web Search  │     │ profiles    │          │
│  │ 估值引擎    │     └─────────────┘     └─────────────┘          │
│  └─────────────┘                                                   │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                    Analysis Loop                             │   │
│  │  Intake → Context → Inference → Tool → Reply → Persist      │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                       Hooks                                  │   │
│  │  analysis:start → phase_complete → report → quality → end   │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                  文件即状态 (Persistence)                    │   │
│  │  reports/*.md  │  history/*.jsonl  │  skills/*.yaml         │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 设计原则总结

| 原则 | 核心要点 | 好处 |
|------|---------|------|
| 单点协调 | Master Framework统一管理 | 状态一致、易调试 |
| 文件即状态 | MD/YAML/JSONL存储 | 无需数据库、可Git |
| Context管理 | 三层策略、优先级规则 | 高效利用token |
| 分析Loop | 6阶段标准流程 | 可追踪、可优化 |
| Session隔离 | 分析类型决定隔离策略 | 避免状态污染 |
| Hook扩展 | 生命周期钩子 | 灵活扩展、不改核心 |
| Skill模块化 | 能力解耦、按需加载 | 可迭代、可组合 |

---

## 版本历史

| 版本 | 日期 | 变更 |
|------|------|------|
| v1.0 | 2026-01-30 | 初始版本，基于Clawdbot设计洞见 |

---

*学习来源：Clawdbot Gateway架构设计*
