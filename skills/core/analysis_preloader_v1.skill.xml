<?xml version="1.0" encoding="UTF-8"?>
<skill id="analysis_preloader" version="1.0">
  <metadata>
    <name>Analysis Preloader</name>
    <description>强制性前置加载器，在新公司分析前加载所有Agent和Skill到上下文</description>
    <author>Investment Research System</author>
    <created>2026-01-27</created>
    <category>core</category>
    <priority>P0</priority>
    <trigger_type>MANDATORY_BEFORE_ANALYSIS</trigger_type>
  </metadata>

  <trigger_conditions>
    <condition type="intent_match">
      <patterns>
        <pattern>分析.*公司</pattern>
        <pattern>研究.*股票</pattern>
        <pattern>调研.*</pattern>
        <pattern>写.*研究报告</pattern>
        <pattern>深度分析.*</pattern>
        <pattern>analyze.*company</pattern>
        <pattern>research.*stock</pattern>
      </patterns>
    </condition>
  </trigger_conditions>

  <execution>
    <step order="1" name="load_agent_registry">
      <description>加载所有Agent定义到上下文</description>
      <action type="read_files">
        <files>
          <file>skills/research_mechanism/research_mechanism_agent_v1.1.yaml</file>
          <file>skills/valuation_engine/valuation_engine_agent_v1.yaml</file>
          <file>skills/ecosystem_graph/ecosystem_graph_agent_v2.4.yaml</file>
          <file>skills/data_integrity/data_integrity_agent_v2.2.yaml</file>
          <file>skills/innovation_engine/innovation_agent_v1.yaml</file>
          <file>skills/quality_gate/quality_gate_agent_v2.2.yaml</file>
          <file>skills/eval_agent/eval_regression_agent_v1.3.yaml</file>
        </files>
      </action>
    </step>

    <step order="2" name="load_innovation_pipeline">
      <description>加载Innovation Agent完整Pipeline</description>
      <action type="read_files">
        <files>
          <file>skills/innovation_engine/docs/INNOV_v1_README.md</file>
          <file>skills/innovation_engine/schemas/innovation_hypothesis_schema_v1.yaml</file>
          <file>skills/innovation_engine/policies/analogy_domain_library_v1.yaml</file>
        </files>
      </action>
    </step>

    <step order="3" name="load_output_schemas">
      <description>加载所有输出格式定义</description>
      <action type="read_files">
        <files>
          <file>skills/research_mechanism/schemas/claim_spec_schema_v1.yaml</file>
          <file>skills/valuation_engine/schemas/cap_hypothesis_schema_v1.yaml</file>
          <file>skills/ecosystem_graph/schemas/eco_signal_schema_v2.yaml</file>
        </files>
      </action>
    </step>

    <step order="4" name="identify_industry">
      <description>识别公司行业并加载对应模板</description>
      <action type="classify">
        <industry_templates>
          <template industry="制造/硬件">PVM拆解 + 供应链 + 产能分析</template>
          <template industry="SaaS/订阅">ARR拆解 + 队列分析 + Rule of 40</template>
          <template industry="REIT">NAV模型 + FFO分析 + 物业组合</template>
          <template industry="平台/市场">GMV×Take Rate + 网络效应 + 双边UE</template>
          <template industry="E&amp;P/资源">储量评估 + 成本曲线 + 油价敏感性</template>
          <template industry="金融/银行">NIM拆解 + 资产质量 + 资本充足率</template>
          <template industry="生物医药">管线rNPV + 临床概率 + 现金跑道</template>
          <template industry="消费品ToC">品牌资产 + 渠道分析 + 用户LTV</template>
        </industry_templates>
      </action>
    </step>

    <step order="5" name="verify_checklist">
      <description>验证所有必需组件已加载</description>
      <action type="checklist">
        <items>
          <item>Innovation Agent Pipeline 已理解</item>
          <item>ClaimSpec 格式已准备</item>
          <item>CAP Hypothesis 格式已准备</item>
          <item>Ecosystem Element 格式已准备</item>
          <item>类比领域库已加载</item>
          <item>相关分析 Skill 已识别</item>
          <item>FMP API 数据源已确认</item>
          <item>公司行业已识别</item>
        </items>
      </action>
    </step>

    <step order="6" name="output_context_summary">
      <description>输出加载摘要供后续分析使用</description>
      <action type="generate_summary">
        <format>
          <section name="已加载Agent">列出所有Agent及版本</section>
          <section name="已加载Skill">列出相关Skill</section>
          <section name="输出格式要求">列出必须使用的schema</section>
          <section name="行业模板">显示选定的行业分析模板</section>
        </format>
      </action>
    </step>
  </execution>

  <output_requirements>
    <requirement type="structured_hypothesis" min_count="3" schema="innovation_hypothesis_schema_v1"/>
    <requirement type="cross_domain_analogy" min_count="1" source="analogy_domain_library"/>
    <requirement type="claim_spec" min_count="2" schema="claim_spec_v1"/>
    <requirement type="cap_hypothesis" min_count="2" schema="cap_hypothesis"/>
    <requirement type="ecosystem_element" min_count="3" entities="true" relationships="2"/>
    <requirement type="novelty_score" for_each="structured_hypothesis"/>
  </output_requirements>

  <kill_switch>
    <condition>如果任何必需组件加载失败，停止分析并报告缺失项</condition>
  </kill_switch>
</skill>
