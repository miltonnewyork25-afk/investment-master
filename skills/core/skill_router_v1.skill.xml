<?xml version="1.0" encoding="UTF-8"?>
<skill id="skill_router" version="1.0">
  <metadata>
    <name>Skill Router</name>
    <description>根据公司特性动态路由选择最相关的Skill组合，生成临时执行计划</description>
    <author>Investment Research System</author>
    <created>2026-01-27</created>
    <category>core</category>
    <priority>P0</priority>
    <trigger_type>MANDATORY_AFTER_PRELOAD</trigger_type>
    <depends_on>analysis_preloader</depends_on>
  </metadata>

  <routing_layers>
    <!-- Layer 1: Industry Routing -->
    <layer id="industry" order="1">
      <route industry="制造/硬件">
        <required_skills>
          <skill>pvm_analysis</skill>
          <skill>supply_chain_risk</skill>
          <skill>capacity_utilization</skill>
        </required_skills>
        <optional_skills>
          <skill>learning_curve_analysis</skill>
        </optional_skills>
      </route>
      <route industry="SaaS/订阅">
        <required_skills>
          <skill>arr_cohort_analysis</skill>
          <skill>rule_of_40</skill>
          <skill>net_dollar_retention</skill>
        </required_skills>
      </route>
      <route industry="AI/科技平台">
        <required_skills>
          <skill>data_moat_quantifier</skill>
          <skill>ai_competitive_landscape</skill>
          <skill>capex_intensive_valuation</skill>
          <skill>platform_portfolio_matrix</skill>
        </required_skills>
        <optional_skills>
          <skill>robotaxi_valuation</skill>
          <skill>cloud_competitive_tracker</skill>
        </optional_skills>
      </route>
      <!-- Additional industries... -->
    </layer>

    <!-- Layer 2: Company Characteristics -->
    <layer id="characteristics" order="2">
      <route condition="revenue_growth_yoy > 0.30">
        <add_skill>high_growth_tech_valuation</add_skill>
      </route>
      <route condition="net_income < 0">
        <add_skill>cash_burn_analysis</add_skill>
        <add_skill>path_to_profitability</add_skill>
      </route>
      <route condition="capex_revenue_ratio > 0.15">
        <add_skill>capex_intensive_valuation</add_skill>
      </route>
      <route condition="regulatory_sensitive = true">
        <add_skill>regulatory_risk_framework</add_skill>
      </route>
      <route condition="ceo_dependent = true">
        <add_skill>key_person_risk_analysis</add_skill>
      </route>
      <route condition="business_lines >= 3">
        <add_skill>sotp_valuation</add_skill>
        <add_skill>conglomerate_discount</add_skill>
      </route>
      <route condition="beta > 1.3">
        <add_skill>macro_industry_cycle</add_skill>
        <add_skill>cyclical_timing</add_skill>
      </route>
      <route condition="ai_core_business = true">
        <add_skill>ai_option_valuation</add_skill>
        <add_skill>ai_competitive_landscape</add_skill>
      </route>
      <route condition="data_is_core_asset = true">
        <add_skill>data_moat_quantifier</add_skill>
      </route>
    </layer>

    <!-- Layer 3: Market Environment -->
    <layer id="market_env" order="3">
      <route condition="pe_ratio > 50 OR ps_ratio > 10">
        <add_skill>valuation_sanity_check</add_skill>
      </route>
      <route condition="short_interest > 0.10">
        <add_skill>short_squeeze_analysis</add_skill>
      </route>
      <route condition="analyst_target_divergence > 0.50">
        <add_skill>consensus_divergence_analysis</add_skill>
      </route>
      <route condition="days_to_earnings < 30">
        <add_skill>earnings_surprise_predictor</add_skill>
      </route>
    </layer>
  </routing_layers>

  <execution>
    <step order="1" name="fetch_company_data">
      <description>获取公司基础数据用于路由决策</description>
      <action type="api_call">
        <endpoint>/stable/profile</endpoint>
        <endpoint>/api/v3/quote</endpoint>
        <endpoint>/stable/financial-scores</endpoint>
      </action>
    </step>

    <step order="2" name="classify_industry">
      <description>识别公司行业分类（可能多个）</description>
      <action type="classify">
        <output>industry_list</output>
      </action>
    </step>

    <step order="3" name="identify_characteristics">
      <description>识别公司特性标签</description>
      <action type="evaluate_conditions">
        <output>characteristics_list</output>
      </action>
    </step>

    <step order="4" name="assess_market_env">
      <description>评估当前市场环境</description>
      <action type="evaluate_conditions">
        <output>market_env_factors</output>
      </action>
    </step>

    <step order="5" name="select_skills">
      <description>根据三层路由选择Skill组合</description>
      <action type="aggregate">
        <tier1>industry_skills</tier1>
        <tier2>characteristic_skills</tier2>
        <tier3>market_env_skills</tier3>
        <output>selected_skill_list</output>
      </action>
    </step>

    <step order="6" name="determine_agent_activation">
      <description>确定需要激活的Agent及输出要求</description>
      <action type="map">
        <agent id="research_mechanism_agent" min_output="3"/>
        <agent id="valuation_engine_agent" min_output="2"/>
        <agent id="ecosystem_graph_agent" min_output="3"/>
        <agent id="innovation_agent" min_output="3"/>
      </action>
    </step>

    <step order="7" name="generate_execution_plan">
      <description>生成临时执行计划文件</description>
      <action type="write_file">
        <path_template>.analysis_temp/{ticker}_{timestamp}_execution_plan.yaml</path_template>
        <format>yaml</format>
      </action>
    </step>

    <step order="8" name="output_routing_summary">
      <description>输出路由摘要供分析使用</description>
      <action type="generate_summary">
        <sections>
          <section>公司识别</section>
          <section>选中的Skill组合</section>
          <section>Agent激活计划</section>
          <section>临时执行计划路径</section>
        </sections>
      </action>
    </step>
  </execution>

  <cleanup>
    <trigger condition="quality_gate_pass">
      <action>delete_execution_plan</action>
    </trigger>
    <trigger condition="user_confirms_completion">
      <action>delete_execution_plan</action>
    </trigger>
    <trigger condition="file_age > 72_hours">
      <action>force_delete_execution_plan</action>
    </trigger>
  </cleanup>

  <output_requirements>
    <requirement type="routing_summary" format="markdown"/>
    <requirement type="execution_plan" format="yaml" location=".analysis_temp/"/>
  </output_requirements>
</skill>
