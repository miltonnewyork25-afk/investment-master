# Plan-and-Execute Framework v1.0
# åˆ†å±‚æ‰§è¡Œæ¶æ„: è´µæ¨¡å‹è§„åˆ’ + ä¾¿å®œæ¨¡å‹æ‰§è¡Œ
# æ¥æº: LangChain, arXiv:2509.08646, Plan-and-Act (OpenReview)

version: "1.0"
created: "2026-01-31"
description: |
  å°†æˆ˜ç•¥è§„åˆ’ä¸æˆ˜æœ¯æ‰§è¡Œåˆ†ç¦»ï¼Œå®ç°æˆæœ¬ä¼˜åŒ–ã€‚

  æ ¸å¿ƒæ´å¯Ÿ:
  "Plan-then-Execute å‰ç½®ä¸»è¦ LLM æˆæœ¬åˆ°åˆå§‹è§„åˆ’é˜¶æ®µï¼Œ
  ä¹‹åæ‰§è¡Œå¯ä»¥æ›´å¿«ã€æ›´ä¾¿å®œåœ°è¿›è¡Œã€‚"

  æˆæœ¬èŠ‚çœé¢„æœŸ: 70-90%

# ============================================================
# æ¶æ„æ¦‚è§ˆ
# ============================================================
architecture:
  overview: |
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    ç”¨æˆ·è¯·æ±‚                              â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  ğŸ§  PLANNER (Opus 4.5)                                  â”‚
    â”‚  â”œâ”€ ç†è§£ä»»åŠ¡å…¨è²Œ                                        â”‚
    â”‚  â”œâ”€ åˆ†è§£ä¸ºå­ä»»åŠ¡                                        â”‚
    â”‚  â”œâ”€ ç¡®å®šæ‰§è¡Œé¡ºåº                                        â”‚
    â”‚  â””â”€ ç”Ÿæˆç»“æ„åŒ–è®¡åˆ’                                      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ ç»“æ„åŒ–è®¡åˆ’
                             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  âš¡ EXECUTOR (Haiku/Sonnet)                             â”‚
    â”‚  â”œâ”€ æ‰§è¡Œå…·ä½“å­ä»»åŠ¡                                      â”‚
    â”‚  â”œâ”€ è°ƒç”¨å·¥å…·å’Œ API                                      â”‚
    â”‚  â”œâ”€ æ”¶é›†æ‰§è¡Œç»“æœ                                        â”‚
    â”‚  â””â”€ æŠ¥å‘Šæ‰§è¡ŒçŠ¶æ€                                        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ æ‰§è¡Œç»“æœ
                             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  ğŸ§  SYNTHESIZER (Opus 4.5)                              â”‚
    â”‚  â”œâ”€ æ•´åˆæ‰§è¡Œç»“æœ                                        â”‚
    â”‚  â”œâ”€ åˆ¤æ–­æ˜¯å¦éœ€è¦é‡è§„åˆ’                                  â”‚
    â”‚  â””â”€ ç”Ÿæˆæœ€ç»ˆè¾“å‡º                                        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

# ============================================================
# æ¨¡å‹åˆ†é…ç­–ç•¥
# ============================================================
model_allocation:

  planner:
    model: "opus"
    description: "æˆ˜ç•¥è§„åˆ’ï¼Œéœ€è¦å¼ºæ¨ç†èƒ½åŠ›"
    tasks:
      - "ç†è§£å¤æ‚ä»»åŠ¡"
      - "åˆ†è§£å­ä»»åŠ¡"
      - "è¯†åˆ«ä¾èµ–å…³ç³»"
      - "å¤„ç†å¼‚å¸¸æƒ…å†µ"
      - "æœ€ç»ˆç»¼åˆåˆ¤æ–­"

    when_to_use:
      - "åˆå§‹è§„åˆ’é˜¶æ®µ"
      - "é‡åˆ°æ‰§è¡Œå¤±è´¥éœ€è¦é‡è§„åˆ’"
      - "éœ€è¦åˆ›æ„/æ´å¯Ÿçš„åˆ†æ"
      - "æœ€ç»ˆæŠ¥å‘Šç»¼åˆ"

  executor:
    model: "haiku"
    description: "æˆ˜æœ¯æ‰§è¡Œï¼Œé‡å¤æ€§ä»»åŠ¡"
    tasks:
      - "API æ•°æ®è·å–"
      - "ç»“æ„åŒ–æ•°æ®æå–"
      - "ç®€å•è®¡ç®—"
      - "æ ¼å¼è½¬æ¢"
      - "æ¨¡æ¿å¡«å……"

    when_to_use:
      - "æ‰§è¡Œæ˜ç¡®å®šä¹‰çš„å­ä»»åŠ¡"
      - "è°ƒç”¨å·¥å…·å’Œ API"
      - "æ•°æ®å¤„ç†å’Œè½¬æ¢"

  fallback:
    model: "sonnet"
    description: "ä¸­ç­‰å¤æ‚åº¦ä»»åŠ¡"
    tasks:
      - "Haiku å¤±è´¥åçš„é‡è¯•"
      - "éœ€è¦ä¸€å®šæ¨ç†ä½†éæ ¸å¿ƒçš„ä»»åŠ¡"

# ============================================================
# ä»»åŠ¡åˆ†ç±»
# ============================================================
task_classification:

  planner_tasks:
    description: "éœ€è¦ Opus çš„ä»»åŠ¡"
    examples:
      - type: "strategic_planning"
        example: "è®¾è®¡ MU æ·±åº¦åˆ†æçš„æ•´ä½“æ¡†æ¶"
        reason: "éœ€è¦å…¨å±€è§†è§’å’Œå¤æ‚æ¨ç†"

      - type: "insight_generation"
        example: "ç”Ÿæˆåå¸¸è¯†æ´å¯Ÿå¡"
        reason: "éœ€è¦åˆ›æ„å’Œæ·±åº¦æ€è€ƒ"

      - type: "complex_synthesis"
        example: "æ•´åˆå¤šæºæ•°æ®å¾—å‡ºæŠ•èµ„ç»“è®º"
        reason: "éœ€è¦è·¨é¢†åŸŸç»¼åˆåˆ¤æ–­"

      - type: "error_recovery"
        example: "æ‰§è¡Œå¤±è´¥åé‡æ–°è§„åˆ’"
        reason: "éœ€è¦åˆ†æå¤±è´¥åŸå› å¹¶è°ƒæ•´ç­–ç•¥"

  executor_tasks:
    description: "å¯ä»¥ç”¨ Haiku çš„ä»»åŠ¡"
    examples:
      - type: "api_call"
        example: "è°ƒç”¨ FMP API è·å–è´¢åŠ¡æ•°æ®"
        reason: "æ˜ç¡®è¾“å…¥è¾“å‡ºï¼Œæ— éœ€å¤æ‚æ¨ç†"

      - type: "data_extraction"
        example: "ä» 10-K æå–ç‰¹å®šæ•°å­—"
        reason: "ç»“æ„åŒ–æå–ï¼Œè§„åˆ™æ˜ç¡®"

      - type: "format_conversion"
        example: "å°† JSON è½¬æ¢ä¸º Markdown è¡¨æ ¼"
        reason: "çº¯æ ¼å¼è½¬æ¢ï¼Œæ— éœ€åˆ¤æ–­"

      - type: "template_filling"
        example: "å¡«å……é¢„æµ‹è¿½è¸ªæ¨¡æ¿"
        reason: "æ¨¡æ¿æ˜ç¡®ï¼Œåªéœ€å¡«å…¥æ•°æ®"

      - type: "simple_calculation"
        example: "è®¡ç®— ROIC = NOPAT / Invested Capital"
        reason: "å…¬å¼æ˜ç¡®ï¼Œç®€å•è®¡ç®—"

# ============================================================
# è®¡åˆ’æ ¼å¼
# ============================================================
plan_format:

  structure: |
    ## æ‰§è¡Œè®¡åˆ’

    **ä»»åŠ¡**: {task_description}
    **ç”Ÿæˆæ—¶é—´**: {timestamp}
    **é¢„è®¡æ­¥éª¤æ•°**: {step_count}

    ### æ­¥éª¤åˆ—è¡¨

    | æ­¥éª¤ | æè¿° | æ‰§è¡Œæ¨¡å‹ | ä¾èµ– | é¢„æœŸè¾“å‡º |
    |------|------|---------|------|---------|
    | 1 | {step_1_desc} | {model} | - | {output_1} |
    | 2 | {step_2_desc} | {model} | 1 | {output_2} |
    | ... | ... | ... | ... | ... |

    ### æ£€æŸ¥ç‚¹
    - æ­¥éª¤ {n} å®ŒæˆåéªŒè¯: {validation}

    ### å¤±è´¥å¤„ç†
    - å¦‚æœæ­¥éª¤ {n} å¤±è´¥: {fallback_action}

  step_schema:
    step_id: "integer"
    description: "string"
    model: "[opus/sonnet/haiku]"
    dependencies: "[step_ids]"
    inputs: "[required_inputs]"
    expected_output: "string"
    timeout: "seconds"
    retry_count: "integer"
    fallback: "string"

# ============================================================
# æŠ•èµ„åˆ†æä»»åŠ¡åˆ†è§£
# ============================================================
investment_analysis_decomposition:

  phase_1_positioning:
    planner_tasks:
      - "è®¾è®¡ç”Ÿæ€å›¾è°±ç»“æ„"
      - "ç¡®å®šäº§ä¸šé“¾å®šä½æ–¹æ³•"

    executor_tasks:
      - "è°ƒç”¨ API è·å–å…¬å¸åŸºç¡€ä¿¡æ¯"
      - "æœç´¢ç«äº‰å¯¹æ‰‹åˆ—è¡¨"
      - "æ”¶é›†ä¾›åº”å•†/å®¢æˆ·ä¿¡æ¯"

  phase_2_data:
    planner_tasks:
      - "ç¡®å®šéœ€è¦å“ªäº›æ•°æ®ç‚¹"
      - "è®¾è®¡æ•°æ®ä¼˜å…ˆçº§"

    executor_tasks:
      - "è°ƒç”¨ FMP API"
      - "è°ƒç”¨ 100baggers API"
      - "æ‰§è¡Œ WebSearch æ”¶é›†åˆ†æå¸ˆè§‚ç‚¹"
      - "æå–è´¢æŠ¥æ•°æ®"

  phase_3_analysis:
    planner_tasks:
      - "æŠ¤åŸæ²³æ·±åº¦åˆ†æ"
      - "æ ¸å¿ƒå‘½é¢˜æ„å»º"
      - "åå¸¸è¯†æ´å¯Ÿç”Ÿæˆ"
      - "Reflection è‡ªæˆ‘æ‰¹è¯„"

    executor_tasks:
      - "è®¡ç®—è´¢åŠ¡æŒ‡æ ‡"
      - "å¡«å……åˆ†ææ¨¡æ¿"
      - "æ ¼å¼åŒ–è¾“å‡º"

  phase_4_decision:
    planner_tasks:
      - "ä¼°å€¼æ¨¡å‹é€‰æ‹©å’Œè°ƒæ•´"
      - "Kill Switch è®¾è®¡"
      - "æœ€ç»ˆæŠ•èµ„å»ºè®®"

    executor_tasks:
      - "DCF è®¡ç®—"
      - "æ•æ„Ÿæ€§åˆ†æè®¡ç®—"
      - "é¢„æµ‹è¿½è¸ªæ¨¡æ¿å¡«å……"

# ============================================================
# æˆæœ¬ä¼°ç®—
# ============================================================
cost_estimation:

  baseline:
    description: "å…¨éƒ¨ä½¿ç”¨ Opus"
    typical_analysis:
      input_tokens: 200000
      output_tokens: 50000
      cost_per_1m_input: 15.00  # USD
      cost_per_1m_output: 75.00
      total_cost: 6.75  # USD

  optimized:
    description: "Plan-and-Execute æ¨¡å¼"
    breakdown:
      planner:
        model: "opus"
        input_tokens: 50000   # 25% of total
        output_tokens: 10000  # 20% of total
        cost: 1.50

      executor:
        model: "haiku"
        input_tokens: 150000  # 75% of total
        output_tokens: 40000  # 80% of total
        cost_per_1m_input: 0.25
        cost_per_1m_output: 1.25
        cost: 0.09

      total_cost: 1.59

    savings:
      absolute: 5.16  # USD
      percentage: 76%

# ============================================================
# æ‰§è¡Œæµç¨‹
# ============================================================
execution_flow:

  step_1_plan:
    model: "opus"
    action: "ç”Ÿæˆæ‰§è¡Œè®¡åˆ’"
    output: "ç»“æ„åŒ–è®¡åˆ’ (plan.yaml)"

  step_2_execute:
    model: "haiku"
    action: "æŒ‰è®¡åˆ’æ‰§è¡Œå­ä»»åŠ¡"
    parallel: true  # æ— ä¾èµ–çš„ä»»åŠ¡å¯å¹¶è¡Œ
    output: "æ‰§è¡Œç»“æœ (results/)"

  step_3_monitor:
    action: "ç›‘æ§æ‰§è¡ŒçŠ¶æ€"
    on_failure:
      - "è®°å½•å¤±è´¥åŸå› "
      - "å°è¯• fallback"
      - "å¦‚éœ€é‡è§„åˆ’ï¼Œè°ƒç”¨ Opus"

  step_4_synthesize:
    model: "opus"
    action: "æ•´åˆç»“æœï¼Œç”Ÿæˆæœ€ç»ˆè¾“å‡º"
    output: "æœ€ç»ˆæŠ¥å‘Š"

# ============================================================
# é€‚ç”¨åœºæ™¯åˆ¤æ–­
# ============================================================
applicability:

  use_plan_execute:
    conditions:
      - "ä»»åŠ¡å¯åˆ†è§£ä¸º >3 ä¸ªå­ä»»åŠ¡"
      - "å­ä»»åŠ¡ä¹‹é—´æœ‰æ˜ç¡®ä¾èµ–å…³ç³»"
      - "å¤§éƒ¨åˆ†å­ä»»åŠ¡æ˜¯ç»“æ„åŒ–çš„"
      - "æˆæœ¬æ•æ„Ÿ"

    examples:
      - "æ·±åº¦å…¬å¸åˆ†æ"
      - "æ‰¹é‡æ•°æ®æ”¶é›†"
      - "å¤šå…¬å¸å¯¹æ¯”"

  use_direct_opus:
    conditions:
      - "ä»»åŠ¡éœ€è¦æŒç»­çš„åˆ›æ„æ¨ç†"
      - "ä»»åŠ¡ä¸å¯åˆ†è§£"
      - "å®æ—¶å¯¹è¯äº¤äº’"
      - "æ—¶é—´æ•æ„Ÿä¼˜å…ˆäºæˆæœ¬"

    examples:
      - "æŠ•èµ„ç­–ç•¥è®¨è®º"
      - "å¤æ‚é—®é¢˜è¯Šæ–­"
      - "åˆ›æ„æ´å¯Ÿç”Ÿæˆ"

# ============================================================
# å‘½ä»¤
# ============================================================
commands:

  plan_analysis:
    description: "ç”Ÿæˆåˆ†æè®¡åˆ’ï¼ˆä¸æ‰§è¡Œï¼‰"
    usage: "/plan-analysis {TICKER}"
    output: "ç»“æ„åŒ–æ‰§è¡Œè®¡åˆ’"

  execute_plan:
    description: "æ‰§è¡Œå·²ç”Ÿæˆçš„è®¡åˆ’"
    usage: "/execute-plan {plan_file}"
    output: "æ‰§è¡Œç»“æœ"

  cost_estimate:
    description: "ä¼°ç®—ä»»åŠ¡æˆæœ¬"
    usage: "/cost-estimate {task_description}"
    output: "æˆæœ¬å¯¹æ¯”ï¼ˆç›´æ¥ vs Plan-Executeï¼‰"

# ============================================================
# ç‰ˆæœ¬å†å²
# ============================================================
changelog:
  v1.0:
    date: "2026-01-31"
    changes:
      - "åˆå§‹ç‰ˆæœ¬"
      - "ä¸‰å±‚æ¶æ„: Planner + Executor + Synthesizer"
      - "æŠ•èµ„åˆ†æä»»åŠ¡åˆ†è§£"
      - "æˆæœ¬ä¼°ç®—æ¨¡å‹"
    references:
      - "LangChain: Plan-and-Execute Agents"
      - "arXiv:2509.08646: Architecting Resilient LLM Agents"
      - "OpenReview: Plan-and-Act"
