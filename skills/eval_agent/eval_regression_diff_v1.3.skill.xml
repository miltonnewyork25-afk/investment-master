<?xml version="1.0" encoding="UTF-8"?>
<!--
  Eval Regression Diff v1.3
  回归对比器 - 与baseline对比，生成diff报告
  Position: Skill 6
-->
<skill id="eval_regression_diff_v1_3" version="1.3">
  <metadata>
    <name>Eval Regression Diff</name>
    <description>与baseline对比，生成回归diff报告</description>
    <position>6</position>
    <asof>2026-01-27</asof>
    <owner>eval_regression_agent</owner>
  </metadata>

  <!-- 输入规范 -->
  <input>
    <param name="current_results" type="object" required="true">
      <description>当前运行结果</description>
    </param>
    <param name="baseline_version" type="string" required="true">
      <description>基准版本标识</description>
    </param>
    <param name="baseline_registry_path" type="string" required="true">
      <description>基准注册表路径</description>
    </param>
    <param name="comparison_mode" type="string" required="false" default="baseline">
      <description>对比模式: baseline | version_ab | canary</description>
    </param>
    <param name="version_b" type="string" required="false">
      <description>A/B对比时的版本B</description>
    </param>
  </input>

  <!-- 输出规范 -->
  <output>
    <param name="regression_diff" type="object">
      <description>回归对比结果</description>
    </param>
    <param name="delta_summary" type="object">
      <description>变化摘要</description>
    </param>
    <param name="statistical_significance" type="object">
      <description>统计显著性分析</description>
    </param>
  </output>

  <!-- 执行步骤 -->
  <steps>
    <step id="1" name="load_baseline">
      <action>加载基准数据</action>
      <source>baseline_registry_path</source>
      <version_selection>
        <if mode="baseline">use baseline_version</if>
        <if mode="version_ab">use version_b</if>
        <if mode="canary">use "stable"</if>
      </version_selection>
      <format>jsonl.gz</format>
    </step>

    <step id="2" name="align_cases">
      <action>对齐测试用例</action>
      <matching>
        <key>case_id</key>
        <fallback>case_type + input_hash</fallback>
      </matching>
      <categories>
        <matched>both baseline and current</matched>
        <new_cases>only in current</new_cases>
        <removed_cases>only in baseline</removed_cases>
      </categories>
    </step>

    <step id="3" name="compute_score_diff">
      <action>计算评分差异</action>
      <for_each case="matched_cases">
        <compute>
          <score_delta>current.score - baseline.score</score_delta>
          <latency_delta>current.latency - baseline.latency</latency_delta>
          <token_delta>current.tokens - baseline.tokens</token_delta>
        </compute>
        <classify>
          <improved>score_delta > 0.05</improved>
          <degraded>score_delta &lt; -0.05</degraded>
          <stable>abs(score_delta) &lt;= 0.05</stable>
        </classify>
      </for_each>
    </step>

    <step id="4" name="compute_dimension_diff">
      <action>计算维度级差异</action>
      <dimensions>
        <dimension name="task_success">
          <current>current_scorecard.task_success</current>
          <baseline>baseline_scorecard.task_success</baseline>
          <delta>current - baseline</delta>
        </dimension>
        <dimension name="safety_compliance">
          <current>current_scorecard.safety_compliance</current>
          <baseline>baseline_scorecard.safety_compliance</baseline>
          <delta>current - baseline</delta>
          <alert_if>delta &lt; 0</alert_if>
        </dimension>
        <!-- 其他维度同理 -->
      </dimensions>
    </step>

    <step id="5" name="statistical_analysis">
      <action>统计显著性分析</action>
      <tests>
        <test name="t_test">
          <purpose>均值差异显著性</purpose>
          <threshold>p_value &lt; 0.05</threshold>
        </test>
        <test name="mann_whitney">
          <purpose>分布差异显著性</purpose>
          <threshold>p_value &lt; 0.05</threshold>
        </test>
        <test name="chi_square">
          <purpose>通过率差异显著性</purpose>
          <threshold>p_value &lt; 0.05</threshold>
        </test>
      </tests>
      <confidence_level>0.95</confidence_level>
    </step>

    <step id="6" name="generate_summary">
      <action>生成变化摘要</action>
      <summary>
        <overall_delta>
          <improved_count>count of improved cases</improved_count>
          <degraded_count>count of degraded cases</degraded_count>
          <stable_count>count of stable cases</stable_count>
          <new_count>count of new cases</new_count>
          <removed_count>count of removed cases</removed_count>
        </overall_delta>
        <dimension_deltas>per dimension summary</dimension_deltas>
        <key_changes>top 10 most significant changes</key_changes>
        <alerts>
          <if degraded_count > 0>regression detected</if>
          <if safety_delta < 0>safety regression alert</if>
        </alerts>
      </summary>
    </step>

    <step id="7" name="generate_report">
      <action>生成Markdown报告</action>
      <sections>
        <section name="Executive Summary">
          <content>overall_delta, verdict_comparison</content>
        </section>
        <section name="Dimension Comparison">
          <content>side_by_side dimension table</content>
        </section>
        <section name="Significant Changes">
          <content>top improved, top degraded</content>
        </section>
        <section name="Statistical Analysis">
          <content>test results, confidence intervals</content>
        </section>
        <section name="New/Removed Cases">
          <content>list of case_ids</content>
        </section>
      </sections>
    </step>

    <step id="8" name="emit_outputs">
      <action>输出对比结果</action>
      <output>
        <field name="regression_diff">
          <matched_cases>detailed_diffs</matched_cases>
          <new_cases>list</new_cases>
          <removed_cases>list</removed_cases>
          <dimension_diffs>per_dimension</dimension_diffs>
        </field>
        <field name="delta_summary">generated_summary</field>
        <field name="statistical_significance">test_results</field>
      </output>
    </step>
  </steps>

  <!-- A/B对比模式 -->
  <ab_comparison_mode>
    <description>两个版本直接对比</description>
    <usage>version_ab mode with version_b parameter</usage>
    <output>
      <side_by_side>true</side_by_side>
      <winner_declaration>if statistically significant</winner_declaration>
    </output>
  </ab_comparison_mode>

  <!-- Canary对比模式 -->
  <canary_comparison_mode>
    <description>Canary版本与Stable对比</description>
    <usage>canary mode, baseline_version = "stable"</usage>
    <traffic_awareness>true</traffic_awareness>
    <output>
      <promotion_recommendation>if canary >= stable</promotion_recommendation>
      <rollback_recommendation>if canary &lt; stable significantly</rollback_recommendation>
    </output>
  </canary_comparison_mode>

  <!-- 不变量 -->
  <invariants>
    <invariant id="INV-ERD-01" name="consistent_comparison">
      <rule>同一case_id的比较必须一致</rule>
    </invariant>
    <invariant id="INV-ERD-02" name="safety_alert">
      <rule>安全维度下降必须触发告警</rule>
    </invariant>
  </invariants>

  <!-- 错误码 -->
  <error_codes>
    <code id="EVAL_BASELINE_NOT_FOUND" severity="P1">
      <description>基准版本不存在</description>
      <action>SKIP_REGRESSION_DIFF</action>
    </code>
    <code id="EVAL_BASELINE_INCOMPATIBLE" severity="P1">
      <description>基准版本schema不兼容</description>
      <action>WARN_AND_CONTINUE</action>
    </code>
  </error_codes>
</skill>
