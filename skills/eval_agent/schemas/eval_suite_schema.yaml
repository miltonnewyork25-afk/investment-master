# Eval Suite Schema v1.3
# 测试套件JSON Schema定义

version: "1.3"
created: "2026-01-27"

---

# Suite Schema
suite_schema:
  $schema: "https://json-schema.org/draft/2020-12/schema"
  type: object
  required:
    - suite_id
    - name
    - version
    - execution_phase
    - fail_action
    - grader_type
    - cases

  properties:
    suite_id:
      type: string
      format: uuid
      description: "套件唯一标识"

    name:
      type: string
      enum:
        - "canary"
        - "safety"
        - "golden_outcome"
        - "tool_precision"
        - "governance"
        - "metamorphic"
      description: "套件名称"

    version:
      type: string
      pattern: "^\\d+\\.\\d+\\.\\d+$"
      description: "套件版本号"

    description:
      type: string
      maxLength: 500
      description: "套件描述"

    execution_phase:
      type: integer
      minimum: 0
      maximum: 3
      description: "执行阶段(0-3)"

    fail_action:
      type: string
      enum:
        - "ABORT_ALL"
        - "CONTINUE_WITH_FLAG"
        - "LOG_WARNING"
      description: "失败时的动作"

    grader_type:
      type: string
      enum:
        - "rules_only"
        - "rules_primary_llm_secondary"
      description: "Grader类型"

    timeout_ms:
      type: integer
      minimum: 1000
      maximum: 600000
      default: 300000
      description: "套件超时(毫秒)"

    parallel_execution:
      type: boolean
      default: true
      description: "用例是否并行执行"

    cases:
      type: array
      minItems: 1
      items:
        $ref: "#/case_schema"
      description: "测试用例列表"

    metadata:
      type: object
      properties:
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        owner:
          type: string
        tags:
          type: array
          items:
            type: string

---

# Case Schema
case_schema:
  $schema: "https://json-schema.org/draft/2020-12/schema"
  type: object
  required:
    - case_id
    - type
    - input
    - expected_output
    - grader_config

  properties:
    case_id:
      type: string
      format: uuid
      description: "用例唯一标识"

    type:
      type: string
      enum:
        # Canary types
        - "smoke_test"
        - "latency_check"
        - "dependency_check"
        # Safety types
        - "injection_resistance"
        - "pii_protection"
        - "output_safety"
        - "capability_boundary"
        # Golden outcome types
        - "exact_match"
        - "semantic_equivalence"
        - "format_compliance"
        # Tool precision types
        - "tool_selection"
        - "param_validity"
        - "sequence_correctness"
        # Governance types
        - "policy_adherence"
        - "audit_trail"
        - "escalation_trigger"
        # Metamorphic types
        - "input_perturbation"
        - "semantic_invariance"
        - "consistency_check"
      description: "用例类型"

    name:
      type: string
      maxLength: 200
      description: "用例名称"

    description:
      type: string
      maxLength: 1000
      description: "用例描述"

    input:
      type: object
      description: "输入数据"
      properties:
        artifacts:
          type: object
        claim_registry:
          type: array
        evidence_registry:
          type: array
        context:
          type: object
      additionalProperties: true

    expected_output:
      type: object
      description: "预期输出"
      properties:
        verdict:
          type: string
          enum: ["PASS", "DEGRADE", "FAIL", "FAIL_UNTIL_RESOLVED"]
        content:
          type: object
        constraints:
          type: array
          items:
            type: object
      additionalProperties: true

    grader_config:
      type: object
      description: "Grader配置"
      required:
        - primary_grader
      properties:
        primary_grader:
          type: string
          enum:
            - "exact_match"
            - "numeric_range"
            - "schema_validation"
            - "regex_pattern"
            - "semantic_hash"
            - "list_containment"
            - "tool_call_sequence"
        primary_params:
          type: object
        secondary_grader:
          type: string
          enum:
            - "llm_semantic_equivalence"
            - "llm_reasoning_quality"
            - "llm_consistency_check"
        secondary_params:
          type: object
        aggregation:
          type: string
          enum: ["primary_only", "weighted_average", "max", "min"]
          default: "primary_only"

    timeout_ms:
      type: integer
      minimum: 100
      maximum: 60000
      default: 30000
      description: "用例超时(毫秒)"

    retry_config:
      type: object
      properties:
        max_retries:
          type: integer
          minimum: 0
          maximum: 5
          default: 0
        backoff_ms:
          type: integer
          default: 1000

    priority:
      type: string
      enum: ["P0", "P1", "P2"]
      default: "P1"
      description: "优先级"

    tags:
      type: array
      items:
        type: string
      description: "标签"

    source:
      type: object
      description: "用例来源"
      properties:
        type:
          type: string
          enum: ["manual", "auto_generated", "regression"]
        decision_trace_id:
          type: string
          format: uuid
        created_at:
          type: string
          format: date-time

    flakiness:
      type: object
      description: "稳定性信息"
      properties:
        classification:
          type: string
          enum: ["stable", "unstable", "flaky", "very_flaky"]
        variance:
          type: number
          minimum: 0
          maximum: 1
        last_evaluated:
          type: string
          format: date-time
        quarantined:
          type: boolean

---

# Run Result Schema
run_result_schema:
  $schema: "https://json-schema.org/draft/2020-12/schema"
  type: object
  required:
    - run_id
    - suite_id
    - case_id
    - status
    - scores
    - latency_ms
    - timestamp

  properties:
    run_id:
      type: string
      format: uuid
      description: "运行ID"

    suite_id:
      type: string
      format: uuid
      description: "套件ID"

    case_id:
      type: string
      format: uuid
      description: "用例ID"

    status:
      type: string
      enum: ["PASS", "FAIL", "ERROR", "TIMEOUT", "SKIPPED"]
      description: "执行状态"

    scores:
      type: object
      description: "评分详情"
      properties:
        primary_score:
          type: number
          minimum: 0
          maximum: 1
        secondary_score:
          type: number
          minimum: 0
          maximum: 1
        final_score:
          type: number
          minimum: 0
          maximum: 1
        dimension_scores:
          type: object
          additionalProperties:
            type: number

    actual_output:
      type: object
      description: "实际输出"

    diff:
      type: object
      description: "与预期的差异"
      properties:
        type:
          type: string
          enum: ["none", "minor", "major", "critical"]
        details:
          type: array
          items:
            type: object

    grader_details:
      type: object
      description: "Grader详情"
      properties:
        primary:
          type: object
        secondary:
          type: object
        rationale:
          type: string

    latency_ms:
      type: integer
      minimum: 0
      description: "执行延迟(毫秒)"

    token_usage:
      type: integer
      minimum: 0
      description: "Token消耗"

    retries:
      type: integer
      minimum: 0
      description: "重试次数"

    error:
      type: object
      description: "错误信息"
      properties:
        code:
          type: string
        message:
          type: string
        stack:
          type: string

    timestamp:
      type: string
      format: date-time
      description: "执行时间戳"

---

# Scorecard Schema
scorecard_schema:
  $schema: "https://json-schema.org/draft/2020-12/schema"
  type: object
  required:
    - run_id
    - policy_version
    - dimensions
    - release_verdict
    - timestamp

  properties:
    run_id:
      type: string
      format: uuid

    policy_version:
      type: string

    dimensions:
      type: object
      properties:
        task_success:
          $ref: "#/dimension_score"
        safety_compliance:
          $ref: "#/dimension_score"
        tool_precision:
          $ref: "#/dimension_score"
        governance_adherence:
          $ref: "#/dimension_score"
        reasoning_quality:
          $ref: "#/dimension_score"
        consistency:
          $ref: "#/dimension_score"
        latency_sla:
          $ref: "#/dimension_score"
        token_efficiency:
          $ref: "#/dimension_score"

    regression:
      type: object
      properties:
        baseline_version:
          type: string
        baseline_delta:
          type: number
        trend_direction:
          type: string
          enum: ["improving", "stable", "degrading"]
        drift_alerts:
          type: array
          items:
            type: object

    release_verdict:
      type: string
      enum: ["PASS", "DEGRADE_RELEASE", "BLOCK"]

    blocking_reasons:
      type: array
      items:
        type: string

    timestamp:
      type: string
      format: date-time

# Dimension Score Sub-schema
dimension_score:
  type: object
  properties:
    score:
      type: number
      minimum: 0
      maximum: 1
    threshold_pass:
      type: number
    threshold_degrade:
      type: number
    status:
      type: string
      enum: ["pass", "degrade", "fail"]
    source_suite:
      type: string
    case_count:
      type: integer
    pass_count:
      type: integer
