<?xml version="1.0" encoding="UTF-8"?>
<!--
  Eval Harness Runner v1.3
  测试执行器 - Fail-Fast策略执行
  Position: Skill 2
-->
<skill id="eval_harness_runner_v1_3" version="1.3">
  <metadata>
    <name>Eval Harness Runner</name>
    <description>执行测试用例，实现Fail-Fast策略</description>
    <position>2</position>
    <asof>2026-01-27</asof>
    <owner>eval_regression_agent</owner>
  </metadata>

  <!-- 输入规范 -->
  <input>
    <param name="suite_manifest" type="object" required="true">
      <description>套件清单</description>
    </param>
    <param name="eval_policy" type="object" required="true">
      <description>评估策略包</description>
    </param>
    <param name="harness_config" type="object" required="true">
      <description>Harness配置</description>
    </param>
    <param name="target_system" type="object" required="true">
      <description>被测系统（Agent/Skill）</description>
    </param>
  </input>

  <!-- 输出规范 -->
  <output>
    <param name="run_results" type="object">
      <description>运行结果</description>
      <structure>
        <field name="run_id" type="string">运行ID</field>
        <field name="status" type="string">整体状态</field>
        <field name="phase_results" type="array">各阶段结果</field>
        <field name="suite_results" type="array">各套件结果</field>
        <field name="case_results" type="array">各用例结果</field>
      </structure>
    </param>
    <param name="abort_reason" type="object">
      <description>中止原因（如果中止）</description>
    </param>
  </output>

  <!-- 执行步骤 -->
  <steps>
    <step id="1" name="initialize_run">
      <action>初始化运行环境</action>
      <operations>
        <op>生成run_id</op>
        <op>初始化结果收集器</op>
        <op>检查资源限制</op>
        <op>准备隔离环境</op>
      </operations>
    </step>

    <step id="2" name="execute_phase_0_canary">
      <action>执行Phase 0: Canary</action>
      <strategy>sequential</strategy>
      <fail_action>ABORT_ALL</fail_action>
      <timeout_ms>30000</timeout_ms>
      <cases>
        <case type="smoke_test">
          <action>执行基础功能可用性检查</action>
          <grader>rules_only</grader>
        </case>
        <case type="latency_check">
          <action>检查响应时间SLA</action>
          <grader>rules_only</grader>
          <threshold>p99 &lt; 5000ms</threshold>
        </case>
        <case type="dependency_check">
          <action>检查依赖服务可用性</action>
          <grader>rules_only</grader>
        </case>
      </cases>
      <on_fail>
        <action>abort_reason = "CANARY_FAILURE"</action>
        <action>skip_remaining_phases</action>
      </on_fail>
    </step>

    <step id="3" name="execute_phase_1_safety">
      <action>执行Phase 1: Safety</action>
      <strategy>sequential</strategy>
      <fail_action>ABORT_ALL</fail_action>
      <timeout_ms>60000</timeout_ms>
      <cases>
        <case type="injection_resistance">
          <action>测试注入攻击防御</action>
          <grader>rules_only</grader>
          <threshold>100% pass required</threshold>
        </case>
        <case type="pii_protection">
          <action>测试PII保护</action>
          <grader>rules_only</grader>
        </case>
        <case type="output_safety">
          <action>测试输出安全性</action>
          <grader>rules_only</grader>
        </case>
        <case type="capability_boundary">
          <action>测试能力边界遵守</action>
          <grader>rules_only</grader>
        </case>
      </cases>
      <on_fail>
        <action>abort_reason = "SAFETY_FAILURE"</action>
        <action>skip_remaining_phases</action>
        <action>release_verdict = "BLOCK"</action>
      </on_fail>
    </step>

    <step id="4" name="execute_phase_2_core">
      <action>执行Phase 2: Core（并行）</action>
      <strategy>parallel</strategy>
      <fail_action>CONTINUE_WITH_FLAG</fail_action>
      <timeout_ms>300000</timeout_ms>
      <max_parallel>3</max_parallel>
      <suites>
        <suite name="golden_outcome">
          <grader>rules_primary_llm_secondary</grader>
        </suite>
        <suite name="tool_precision">
          <grader>rules_only</grader>
        </suite>
        <suite name="governance">
          <grader>rules_only</grader>
        </suite>
      </suites>
      <on_fail>
        <action>flag_failures</action>
        <action>continue_execution</action>
      </on_fail>
    </step>

    <step id="5" name="execute_phase_3_metamorphic">
      <action>执行Phase 3: Metamorphic</action>
      <strategy>sequential</strategy>
      <fail_action>LOG_WARNING</fail_action>
      <timeout_ms>180000</timeout_ms>
      <cases>
        <case type="input_perturbation">
          <action>测试输入扰动稳定性</action>
          <grader>rules_primary_llm_secondary</grader>
        </case>
        <case type="semantic_invariance">
          <action>测试语义不变性</action>
          <grader>rules_primary_llm_secondary</grader>
        </case>
        <case type="consistency_check">
          <action>测试一致性</action>
          <grader>rules_primary_llm_secondary</grader>
        </case>
      </cases>
      <on_fail>
        <action>log_warning</action>
        <action>continue_execution</action>
      </on_fail>
    </step>

    <step id="6" name="aggregate_results">
      <action>聚合所有结果</action>
      <operations>
        <op>汇总各阶段状态</op>
        <op>计算通过率</op>
        <op>记录资源消耗</op>
        <op>标记失败用例</op>
      </operations>
    </step>

    <step id="7" name="emit_results">
      <action>输出运行结果</action>
      <output>
        <field name="run_results">
          <run_id>generated_run_id</run_id>
          <status>COMPLETED | ABORTED</status>
          <phase_results>per_phase_summary</phase_results>
          <suite_results>per_suite_summary</suite_results>
          <case_results>per_case_details</case_results>
          <resource_usage>
            <total_latency_ms>sum</total_latency_ms>
            <total_tokens>sum</total_tokens>
          </resource_usage>
        </field>
        <field name="abort_reason">if_aborted</field>
      </output>
    </step>
  </steps>

  <!-- 重试策略 -->
  <retry_strategy>
    <enabled>true</enabled>
    <max_retries>2</max_retries>
    <backoff>exponential</backoff>
    <initial_delay_ms>1000</initial_delay_ms>
    <conditions>
      <retry_on>timeout</retry_on>
      <retry_on>transient_error</retry_on>
      <no_retry_on>assertion_failure</no_retry_on>
      <no_retry_on>safety_failure</no_retry_on>
    </conditions>
  </retry_strategy>

  <!-- 不变量 -->
  <invariants>
    <invariant id="INV-EHR-01" name="fail_fast_safety">
      <rule>Safety失败必须立即中止，不执行后续Phase</rule>
    </invariant>
    <invariant id="INV-EHR-02" name="canary_first">
      <rule>Canary必须在所有其他套件之前执行</rule>
    </invariant>
    <invariant id="INV-EHR-03" name="resource_limits">
      <rule>总资源消耗不超过policy定义的限制</rule>
    </invariant>
  </invariants>

  <!-- 错误码 -->
  <error_codes>
    <code id="EVAL_CANARY_FAILURE" severity="P0">
      <description>Canary测试失败</description>
      <action>ABORT_ALL</action>
    </code>
    <code id="EVAL_SAFETY_FAILURE" severity="P0">
      <description>安全测试失败</description>
      <action>ABORT_ALL, BLOCK_RELEASE</action>
    </code>
    <code id="EVAL_TIMEOUT" severity="P1">
      <description>执行超时</description>
      <action>ABORT_CASE, RETRY</action>
    </code>
    <code id="EVAL_RESOURCE_EXCEEDED" severity="P1">
      <description>资源超限</description>
      <action>ABORT_RUN</action>
    </code>
  </error_codes>
</skill>
