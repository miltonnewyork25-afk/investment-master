<?xml version="1.0" encoding="UTF-8"?>
<!-- RM Claim and DAG Builder Skill v1.1 -->
<!-- Position: S1 | Purpose: 构建ClaimSpec Registry + MechanismDAG -->

<skill name="rm_claim_and_dag_builder_v1_1" version="1.1.0" lang="zh">
  <metadata>
    <author>RM Agent System</author>
    <created>2026-01-27</created>
    <theory_refs>
      <ref>Judea Pearl - Causal DAG structure</ref>
      <ref>Ron Adner - Ecosystem risk taxonomy</ref>
      <ref>Karl Popper - Falsifiability criterion</ref>
    </theory_refs>
  </metadata>

  <purpose>
    把上游包（EcosystemPackage + DataConfidenceReport）编译为：
    1. ClaimSpec Registry（结构化因果声明）
    2. MechanismDAG（因果有向无环图）

    每条关键claim必须：
    - 可观测（有observables）
    - 可证伪（有falsify_if + timeframe）
    - 标注Adner风险类型（initiative/co-innovation/adoption chain）
  </purpose>

  <inputs>
    <input name="policy_ref" type="object" required="true">
      {version, hash} 来自S0
    </input>
    <input name="ecosystem_package_ref" type="EcosystemPackage" required="true">
      来自Ecosystem Graph Agent
    </input>
    <input name="data_confidence_ref" type="DataConfidenceReport" required="true">
      来自Data Integrity Agent
    </input>
    <input name="upstream_confidence_cap" type="float" required="true" range="[0,1]">
      上游置信度上限
    </input>
    <input name="upstream_invariants" type="array" required="true">
      [{id, status, details}] 上游不变量结果
    </input>
  </inputs>

  <workflow>
    <step id="s1" name="SelectCandidateClaims">
      <action>
        从上游提取候选claims：
        1. critical_edges（关键依赖边）
        2. substitutes（替代品关系）
        3. rule_edges（规则边）
        4. bottleneck_dependencies（瓶颈依赖）
        5. disruption_edges（颠覆边）
      </action>
      <sources>
        - ecosystem_package_ref.ecosystem_graph
        - ecosystem_package_ref.competition_analysis
        - ecosystem_package_ref.substitute_analysis
        - ecosystem_package_ref.disruption_analysis
      </sources>
    </step>

    <step id="s2" name="BuildClaimSpec">
      <action>
        FOR EACH candidate:
          构建ClaimSpec结构：
          - claim_id: CLM_{TICKER}_{NNN}
          - criticality: CRITICAL/IMPORTANT/OPTIONAL
          - cause: 因变量
          - effect: 果变量
          - sign: POSITIVE/NEGATIVE/NON_MONOTONIC
          - lag: 时滞（0-1Q, 6-18M等）
          - conditions: 前置条件
          - observables: 可观测指标（至少1个）
          - timeframe: 验证时间窗口
          - falsify_if: 证伪条件
          - risk_type: initiative_risk/co_innovation_risk/adoption_chain_risk
          - evidence_refs: 证据引用
          - confidence: 置信度
      </action>
      <validation>
        CRITICAL claims必须有: observables + timeframe + falsify_if + risk_type
      </validation>
    </step>

    <step id="s3" name="BuildDAGNodes">
      <action>
        1. 提取所有唯一的cause和effect
        2. 规范化命名
        3. 创建DAG节点，分类为：
           - driver: 驱动因素
           - constraint: 约束因素
           - intermediate: 中间变量
           - outcome: 结果变量
           - actor: 参与者
           - dependency: 外部依赖
      </action>
    </step>

    <step id="s4" name="BuildDAGEdges">
      <action>
        FOR EACH claim:
          创建边 {from, to, claim_id, edge_confidence, reason_codes}
          edge_confidence继承自claim.confidence
      </action>
    </step>

    <step id="s5" name="RunInvariants">
      <action>
        检查不变量（delegate to invariants_manifest）：
        1. CRITICAL claims必须有observables
        2. CRITICAL claims必须有timeframe
        3. CRITICAL claims必须有falsify_if
        4. CRITICAL claims必须有有效risk_type
        5. DAG必须非空
      </action>
      <on_fail>
        记录失败的invariant_id + 影响的items
      </on_fail>
    </step>

    <step id="s6" name="ComputeConfidence">
      <action>
        计算rm_internal_confidence：
        rm_internal_confidence =
          0.40 * evidence_coverage +
          0.35 * falsifiability +
          0.15 * invariant_pass_rate +
          0.10 * 0.5 (baseline)

        rm_confidence_cap = min(upstream_confidence_cap, rm_internal_confidence)
      </action>
    </step>

    <step id="s7" name="DetermineDegrade">
      <action>
        IF any of:
          - evidence_coverage &lt; policy.ab_coverage_min_on_critical
          - falsifiability &lt; policy.falsifiability_min_on_critical
          - invariant_pass_rate &lt; policy.invariant_pass_rate_min
        THEN: degrade_recommended = true
      </action>
    </step>
  </workflow>

  <scoring>
    <score name="evidence_coverage" range="[0,1]">
      <formula>AB_weighted_coverage_on_critical_claims</formula>
      <description>关键claims的A/B级证据覆盖率</description>
    </score>
    <score name="falsifiability" range="[0,1]">
      <formula>critical_claims_with(falsify_if AND observable AND timeframe) / critical_claims_total</formula>
      <description>关键claims的可证伪性比例</description>
    </score>
    <score name="invariant_pass_rate" range="[0,1]">
      <formula>passed_invariants / total_invariants</formula>
      <description>不变量通过率</description>
    </score>
    <score name="rm_internal_confidence" range="[0,1]">
      <formula>0.40*evidence_coverage + 0.35*falsifiability + 0.15*invariant_pass_rate + 0.10*0.5</formula>
      <description>RM内部置信度</description>
    </score>
  </scoring>

  <reason_codes>
    <code id="RM_DAG_EMPTY" severity="P0" action="DEGRADE">
      MechanismDAG没有因果边
    </code>
    <code id="RM_INVARIANT_FAIL" severity="P0" action="DEGRADE">
      上游或RM不变量检查失败
    </code>
    <code id="RM_CLAIM_MISSING_OBSERVABLE" severity="P1" action="DEGRADE">
      关键claim缺少可观测指标
    </code>
    <code id="RM_FALSIFIABILITY_MISSING" severity="P1" action="DEGRADE">
      关键claim缺少证伪条件
    </code>
    <code id="RM_ECOSYSTEM_RISK_UNMAPPED" severity="P1" action="DEGRADE">
      关键claim未标注Adner风险类型
    </code>
    <code id="RM_EVIDENCE_GAP_CRITICAL" severity="P1" action="DEGRADE">
      关键claims的A/B证据覆盖率低于阈值
    </code>
  </reason_codes>

  <disconfirmers>
    <item>Any CRITICAL claim lacks observable+timeframe+falsify_if</item>
    <item>Any CRITICAL claim lacks risk_type in {initiative_risk, co_innovation_risk, adoption_chain_risk}</item>
    <item>MechanismDAG has zero causal edges</item>
    <item>Evidence coverage on critical claims &lt; 40%</item>
  </disconfirmers>

  <output_contract>
    <field name="claim_registry" type="array" required="true">
      ClaimSpec数组，符合rm_claim_spec_schema.yaml
    </field>
    <field name="mechanism_dag" type="object" required="true">
      {nodes[], edges[], critical_edges[], invariants_results[]}
    </field>
    <field name="rm_internal_confidence" type="float" range="[0,1]" required="true"/>
    <field name="rm_confidence_cap" type="float" range="[0,1]" required="true"/>
    <field name="stats" type="object" required="true">
      {evidence_coverage, falsifiability, invariant_pass_rate}
    </field>
    <field name="degrade_recommended" type="boolean" required="true"/>
    <field name="reason_codes" type="array" items="string"/>
  </output_contract>
</skill>
