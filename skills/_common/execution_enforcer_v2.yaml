# Execution Enforcer v2.0
# 执行强制器 - 确保框架不被"跳过"或"简化"
# 从v1.0升级：增加防退化机制

version: "2.0"
created: "2026-01-31"
predecessor: "execution_enforcer_v1.yaml (已废弃)"

purpose: |
  框架写得再好，如果执行时被跳过或简化，就毫无意义。
  本执行强制器确保每个步骤都被真正执行，而非形式化通过。

# ============================================================
# 核心理念：不可跳过原则
# ============================================================
core_principle:

  name: "不可跳过原则 (No Skip Principle)"

  statement: |
    任何标记为"必须"的步骤都不能跳过。
    任何标记为"最低"的标准都不能降低。
    任何标记为"强制"的检查都不能形式化。

    违反后果：报告不合格，必须返工。

  anti_patterns:
    - name: "形式化通过"
      description: "检查项打勾但实际内容不足"
      example: "洞察卡≥3张 ✓（但每张只有50字）"
      prevention: "增加质量检查，不只是数量检查"

    - name: "选择性执行"
      description: "只执行'容易'的部分，跳过'困难'的"
      example: "跳过竞品深度分析，只列一个表格"
      prevention: "困难部分标记为'不可跳过'"

    - name: "深度债务累积"
      description: "欠下深度债务不还，带债发布"
      example: "某个品类分析明显不足但没补"
      prevention: "债务追踪系统，清零才能发布"

# ============================================================
# 分层执行检查
# ============================================================
layered_enforcement:

  # --------------------------------------------------------
  layer_1_existence_check:
    name: "存在性检查（最基础）"
    description: "检查必须项是否存在"

    checks:
      - "产业链图是否存在？"
      - "生态图谱是否存在？"
      - "护城河分析是否存在？"
      - "估值模型是否存在？"
      - "Kill Switch表是否存在？"

    failure_action: "缺失任何一项 = 立即停止，补充缺失项"

  # --------------------------------------------------------
  layer_2_quantity_check:
    name: "数量检查（基础）"
    description: "检查数量是否达标"

    checks:
      - "总字数≥60,000？"
      - "表格数≥30？"
      - "Mermaid图≥5？"
      - "洞察卡≥5张？"
      - "预测≥15个？"
      - "Kill Switch≥10个？"

    failure_action: "任何一项不达标 = 返回补充，直到达标"

  # --------------------------------------------------------
  layer_3_quality_check:
    name: "质量检查（核心）"
    description: "检查质量是否达标（不只是数量）"

    checks:
      insight_card_quality:
        requirement: "每张洞察卡≥300字"
        additional: "必须包含：传统观点、反常识、机制、证据、投资含义"

      prediction_quality:
        requirement: "每个预测必须可验证"
        additional: "必须包含：验证日期、验证数据源、阈值、置信度"

      moat_analysis_quality:
        requirement: "护城河分析≥5000字"
        additional: "必须逐一评估6类护城河+7Powers"

      competitor_analysis_quality:
        requirement: "主要竞争对手必须单独分析"
        additional: "不能只列表格，必须有深度对比"

    failure_action: "质量不达标 = 返工该模块"

  # --------------------------------------------------------
  layer_4_depth_check:
    name: "深度检查（高级）"
    description: "检查分析是否达到机构级深度"

    checks:
      mechanism_check:
        question: "每个判断是否解释了'为什么'？"
        example_good: "份额45%是因为高深宽比刻蚀技术壁垒，客户转换成本极高"
        example_bad: "份额45%，行业领先"

      counter_evidence_check:
        question: "每个机制是否有反证条件？"
        example_good: "如果竞品在X技术上突破，份额优势可能被侵蚀"
        example_bad: "（无反证）"

      so_what_check:
        question: "每个数据点是否回答了'so what'？"
        example_good: "毛利率50%意味着定价权强劲，支撑估值溢价"
        example_bad: "毛利率50%"

    failure_action: "深度不足 = 执行迭代深挖循环"

# ============================================================
# 阻断点系统 (Blocking Checkpoints)
# ============================================================
blocking_checkpoints:

  description: |
    阻断点 = 必须通过才能继续的检查点。
    不是"建议检查"，是"强制阻断"。

  # --------------------------------------------------------
  checkpoint_phase_1:
    name: "Phase 1 阻断点"
    position: "Phase 1完成后，Phase 2开始前"

    must_have:
      - "产业链定位图 (Mermaid)"
      - "生态图谱 (Mermaid)"
      - "公司类型识别"
      - "Phase 1字数≥10,000"

    blocking_rule: "任何一项缺失 = 不能进入Phase 2"

  # --------------------------------------------------------
  checkpoint_phase_2:
    name: "Phase 2 阻断点"
    position: "Phase 2完成后，Phase 3开始前"

    must_have:
      - "财务数据表 (≥5年)"
      - "分析师观点表 (≥10位，每位有深度引用)"
      - "市场分歧表 (≥5个争议点)"
      - "Phase 2字数≥8,000"

    blocking_rule: "任何一项缺失 = 不能进入Phase 3"

  # --------------------------------------------------------
  checkpoint_phase_3:
    name: "Phase 3 阻断点（最重要）"
    position: "Phase 3完成后，Phase 4开始前"

    must_have:
      - "护城河分析≥5,000字"
      - "行业特定分析≥10,000字"
      - "核心命题≥3个，每个≥1,500字"
      - "反常识洞察≥5张，每张≥300字"
      - "Phase 3字数≥30,000"

    blocking_rule: "任何一项缺失 = 不能进入Phase 4"

  # --------------------------------------------------------
  checkpoint_phase_4:
    name: "Phase 4 阻断点（发布前）"
    position: "Phase 4完成后，发布前"

    must_have:
      - "DCF详细展开"
      - "SOTP三场景"
      - "估值桥梁检查（差距>20%有解释）"
      - "Kill Switch≥10个"
      - "可验证预测≥15个"
      - "总字数≥60,000"
      - "深度评分≥7.5"

    blocking_rule: "任何一项缺失 = 不能发布"

# ============================================================
# 深度债务系统 (Depth Debt System)
# ============================================================
depth_debt_system:

  description: |
    深度债务 = 应该深入分析但暂时跳过的部分。
    债务必须追踪，必须偿还，不能带债发布。

  # --------------------------------------------------------
  debt_types:
    data_debt:
      name: "数据债务"
      examples:
        - "某个数据点没有来源标注"
        - "某个估算没有说明方法"
        - "某个API调用失败没有补救"
      severity: "medium"

    mechanism_debt:
      name: "机制债务"
      examples:
        - "判断缺乏机制解释"
        - "只说'what'没说'why'"
      severity: "high"

    counter_evidence_debt:
      name: "反证债务"
      examples:
        - "机制缺乏反证条件"
        - "没有说明什么情况下判断会错"
      severity: "high"

    coverage_debt:
      name: "覆盖债务"
      examples:
        - "某个重要竞品没有分析"
        - "某个品类被跳过"
        - "某个地区没有覆盖"
      severity: "critical"

    insight_debt:
      name: "洞察债务"
      examples:
        - "洞察卡太简陋"
        - "洞察不够'反常识'"
      severity: "high"

  # --------------------------------------------------------
  debt_tracking:
    format: |
      ## 深度债务追踪表

      | ID | 类型 | 描述 | 严重度 | 欠债时间 | 状态 |
      |----|------|------|--------|---------|------|
      | DD001 | 覆盖债务 | Unilever竞品分析缺失 | Critical | Phase 3 | 未偿还 |
      | DD002 | 机制债务 | 定价权判断缺乏机制 | High | Phase 3 | 未偿还 |

    rules:
      - "发现债务时立即记录"
      - "Critical债务必须当Phase偿还"
      - "High债务必须当天偿还"
      - "Medium债务必须发布前偿还"
      - "不能带任何未偿还债务发布"

# ============================================================
# 防退化机制 (Anti-Regression Mechanisms)
# ============================================================
anti_regression:

  description: |
    专门针对"深度退化"问题设计的防护机制。

  # --------------------------------------------------------
  context_continuation_guard:
    name: "Context延续防护"

    trigger: "检测到'继续'、'continue'、'from where we left'等关键词"

    action: |
      1. 显示警告：⚠️ 检测到Context延续，触发防退化协议
      2. 强制执行标杆对照
      3. 强制执行心态重置
      4. 设定与历史最佳报告相同的最低标准
      5. 不允许任何"简化"或"快速完成"

  # --------------------------------------------------------
  familiarity_guard:
    name: "熟悉度防护"

    trigger: "分析消费品、零售等'日常'行业"

    action: |
      1. 显示警告：⚠️ 熟悉领域，触发复杂度校准
      2. 应用行业复杂度系数
      3. 强制逐品类/逐品牌分析
      4. 最低字数×1.2

  # --------------------------------------------------------
  fatigue_guard:
    name: "框架疲劳防护"

    trigger: "连续完成3份以上报告后"

    action: |
      1. 显示提醒：🔄 框架疲劳风险，强制深度校准
      2. 重读框架核心理念
      3. 重读历史最佳报告
      4. 强制执行迭代深挖循环

  # --------------------------------------------------------
  completion_mindset_guard:
    name: "完成心理防护"

    trigger: "自检发现心态是'完成任务'而非'证明深度'"

    action: |
      1. 停止当前工作
      2. 执行心态重置协议
      3. 重新阅读任务目标
      4. 重新开始当前Phase

# ============================================================
# 强制输出格式
# ============================================================
mandatory_output_format:

  depth_commitment_header:
    position: "报告开头"
    format: |
      ## 深度承诺

      | 指标 | 标杆值 | 本次目标 | 实际值 |
      |------|--------|---------|--------|
      | 总字数 | 63,000 | 60,000 | _____ |
      | 表格数 | 35 | 30 | _____ |
      | Mermaid图 | 6 | 5 | _____ |
      | 洞察卡 | 5 | 5 | _____ |
      | 深度评分 | 8.2 | 7.5 | _____ |

  phase_checkpoint_output:
    position: "每个Phase结束"
    format: |
      ### Phase X 检查点

      □ 字数: _____ / ≥_____
      □ 必须项: X/X 完成
      □ 深度债务: X项（需偿还）

      **状态**: ✅ 通过 / ❌ 未通过，需补充

  final_quality_gate:
    position: "报告末尾"
    format: |
      ## 质量门控执行结果

      ### 数量检查
      | 指标 | 要求 | 实际 | 状态 |
      |------|------|------|------|
      | 总字数 | ≥60,000 | _____ | ✅/❌ |
      | 表格数 | ≥30 | _____ | ✅/❌ |
      | Mermaid图 | ≥5 | _____ | ✅/❌ |

      ### 质量检查
      | 模块 | 评分 | 最低要求 | 状态 |
      |------|------|---------|------|
      | 护城河 | __/10 | 7.0 | ✅/❌ |
      | 洞察卡 | __/10 | 7.0 | ✅/❌ |
      | 估值 | __/10 | 7.0 | ✅/❌ |

      ### 深度债务
      未偿还债务: X项
      债务状态: ✅ 清零 / ❌ 有未偿还

      ### 总评
      **深度评分**: __/10
      **发布状态**: ✅ 可发布 / ❌ 需返工

# ============================================================
# 版本历史
# ============================================================
version_history:
  v2.0:
    date: "2026-01-31"
    trigger: "P&G报告退化事件"
    changes:
      - "增加分层执行检查（存在→数量→质量→深度）"
      - "增加深度债务系统"
      - "增加防退化机制（4类防护）"
      - "增加强制输出格式"
      - "升级阻断点系统"
