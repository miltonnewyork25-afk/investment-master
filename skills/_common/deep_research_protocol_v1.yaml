# ═══════════════════════════════════════════════════════════════════════════
# QUICK INDEX
# ═══════════════════════════════════════════════════════════════════════════
# 名称: Deep Research Protocol / 深度研究执行协议
# 版本: 1.0
#
# 一句话: 分4阶段执行深度研究，每阶段有阻断式检查点
#
# 何时用:
#   - 用户请求"深度调研"、"深度分析"、"完整报告"时
#   - 涉及投资决策的公司研究时
#
# 核心理念:
#   - 分阶段执行 > 一次性输出
#   - 维度完整 > 字数多
#   - 机制分析 > 数据罗列
#   - 阻断式检查 > 事后补救
#
# 状态: active
# ═══════════════════════════════════════════════════════════════════════════

version: "1.0"
created: "2026-01-30"
purpose: "确保深度研究报告不遗漏关键维度"

# =============================================================================
# 第一部分：4阶段执行流程
# =============================================================================

execution_phases:

  overview: |
    深度研究 = 4个阶段 × 每阶段阻断式检查

    Phase 1: 定位与框架选择 (10分钟)
    Phase 2: 数据收集与分析师学习 (20分钟)
    Phase 3: 深度分析执行 (40分钟)
    Phase 4: 估值与输出 (20分钟)

    每个阶段必须完成检查点才能进入下一阶段

  # ---------------------------------------------------------------------------
  # Phase 1: 定位与框架选择
  # ---------------------------------------------------------------------------
  phase_1_positioning:
    name: "定位与框架选择"
    duration: "10分钟"

    mandatory_steps:

      step_1_identify_company_type:
        action: "识别公司类型和行业"
        output: |
          ## Phase 1.1 公司定位
          - 公司: [TICKER]
          - 行业: [行业分类]
          - 类型: [增长股/周期股/Turnaround/防御股/特殊情况]
          - 子行业: [具体细分]

      step_2_select_frameworks:
        action: "根据skill_priority_map选择框架"
        output: |
          ## Phase 1.2 框架选择
          必须使用:
          - [ ] hierarchical_investment_decision_framework
          - [ ] [行业专用框架1]
          - [ ] [行业专用框架2]

          应当使用:
          - [ ] moat_evaluation_framework
          - [ ] product_matrix_network_analysis
          - [ ] [其他相关框架]

      step_3_retrieve_lessons:
        action: "检索相关历史经验"
        output: |
          ## Phase 1.3 相关历史教训
          - LL_XXX: [教训1]
          - LL_XXX: [教训2]
          - LL_XXX: [教训3]

      step_4_ai_stack_positioning:
        action: "如果涉及AI/半导体，确定产业链位置"
        condition: "行业为半导体/AI/科技"
        output: |
          ## Phase 1.4 AI产业链定位
          - 所在层级: Layer [0-5]
          - 领先/滞后指标: [X个月]
          - 上游依赖: [公司列表]
          - 下游客户: [公司列表]
          - 信号传导路径: [描述]

    checkpoint_1:
      name: "Phase 1 检查点"
      must_pass:
        - "公司类型已识别"
        - "框架已选择(≥3个)"
        - "历史lessons已检索(≥3条)"
        - "产业链定位已完成(如适用)"
      blocking: true
      message: "Phase 1 检查点未通过，不能进入Phase 2"

  # ---------------------------------------------------------------------------
  # Phase 2: 数据收集与分析师学习
  # ---------------------------------------------------------------------------
  phase_2_data_collection:
    name: "数据收集与分析师学习"
    duration: "20分钟"

    mandatory_steps:

      step_1_api_data:
        action: "调用FMP和100baggers API"
        output: |
          ## Phase 2.1 API数据

          ### FMP数据
          | 指标 | 数值 | 来源 |
          |------|------|------|
          | PE (TTM) | X | [API] |
          | EV/EBITDA | X | [API] |
          | 毛利率 | X% | [API] |
          | ROIC | X% | [API] |
          | Z-Score | X | [API] |
          | F-Score | X/9 | [API] |

          ### 100baggers数据
          | 指标 | 数值 | 来源 |
          |------|------|------|
          | 领先指标触发 | X/5 | [API] |
          | 杜邦拆解 | ROE=X×X×X | [API] |
          | ROIC趋势 | X | [API] |

      step_2_analyst_search:
        action: "搜索5-10位顶级分析师观点"
        output: |
          ## Phase 2.2 顶级分析师全景

          | 分析师 | 机构 | 评级 | 目标价 | 核心逻辑 | 方法论 | 盲区 |
          |--------|------|------|--------|----------|--------|------|
          | [名字] | [机构] | [评级] | $X | [逻辑] | [方法] | [盲区] |
          | ... | ... | ... | ... | ... | ... | ... |

          **分析师共识**:
          - 买入: X位
          - 持有: X位
          - 卖出: X位
          - 平均目标价: $X

      step_3_market_divergence:
        action: "识别市场核心分歧"
        output: |
          ## Phase 2.3 市场核心分歧

          | 争议点 | 多头观点 | 空头观点 | 我的判断 | 关键证据 |
          |--------|----------|----------|----------|----------|
          | [争议1] | [观点] | [观点] | [判断] | [证据] |
          | [争议2] | [观点] | [观点] | [判断] | [证据] |
          | [争议3] | [观点] | [观点] | [判断] | [证据] |

      step_4_competitive_landscape:
        action: "收集竞争格局数据"
        output: |
          ## Phase 2.4 竞争格局

          | 竞争对手 | 市场份额 | 核心优势 | 核心劣势 | 威胁程度 |
          |----------|----------|----------|----------|----------|
          | [公司1] | X% | [优势] | [劣势] | 高/中/低 |
          | [公司2] | X% | [优势] | [劣势] | 高/中/低 |

    checkpoint_2:
      name: "Phase 2 检查点"
      must_pass:
        - "FMP API数据已获取并展示"
        - "100baggers API数据已获取并展示"
        - "分析师观点≥5位"
        - "市场分歧≥3个"
        - "竞争对手≥3个"
      blocking: true
      message: "Phase 2 检查点未通过，不能进入Phase 3"

  # ---------------------------------------------------------------------------
  # Phase 3: 深度分析执行
  # ---------------------------------------------------------------------------
  phase_3_deep_analysis:
    name: "深度分析执行"
    duration: "40分钟"

    mandatory_modules:

      module_1_decision_framework:
        name: "层级决策框架执行"
        required: true
        output: |
          ## Phase 3.1 层级决策框架

          ### Level 0: 硬性排除检查
          - [ ] 结构性颠覆? → [是/否] 理由: ___
          - [ ] 二元事件依赖? → [是/否] 理由: ___
          - [ ] 欺诈/治理危机? → [是/否] 理由: ___
          - [ ] 流动性危机? → [是/否] 理由: ___
          **Level 0 结果**: 通过/排除

          ### Level 1: 必要条件门
          - [ ] 问题可解决? → [是/否] 理由: ___
          - [ ] 护城河完好? → [是/否] 理由: ___
          - [ ] 有催化剂? → [是/否] 理由: ___
          - [ ] 估值合理? → [是/否] 理由: ___
          - [ ] 风险回报OK? → [是/否] 理由: ___
          **Level 1 结果**: 通过/观察名单

          ### Level 2: 例外触发器检查
          - [ ] 绝对垄断+宏观顺风? → [是/否]
          - [ ] 多重修复信号确认? → [是/否]
          - [ ] 极端估值+业务完好? → [是/否]
          **Level 2 结果**: 触发例外/继续Level 3-4

          ### Level 3: 情景分类
          **分类结果**: [增长股/Turnaround/周期股/防御股/特殊情况]
          **分类理由**: ___

          ### Level 4: 情景内评估
          [根据情景使用对应评估维度和权重]

      module_2_moat_analysis:
        name: "护城河深度分析"
        required: true
        output: |
          ## Phase 3.2 护城河深度分析

          ### 护城河类型识别
          | 类型 | 存在? | 强度(1-5) | 证据 |
          |------|-------|-----------|------|
          | 转换成本 | 是/否 | X | [证据] |
          | 网络效应 | 是/否 | X | [证据] |
          | 规模经济 | 是/否 | X | [证据] |
          | 成本优势 | 是/否 | X | [证据] |
          | 无形资产(品牌/专利) | 是/否 | X | [证据] |
          | 监管护城河 | 是/否 | X | [证据] |

          ### 7 Powers评估
          | Power | 适用? | 评分(1-10) | 机制分析 |
          |-------|-------|------------|----------|
          | Scale Economies | 是/否 | X | [为什么] |
          | Network Effects | 是/否 | X | [为什么] |
          | Counter-Positioning | 是/否 | X | [为什么] |
          | Switching Costs | 是/否 | X | [为什么] |
          | Branding | 是/否 | X | [为什么] |
          | Cornered Resource | 是/否 | X | [为什么] |
          | Process Power | 是/否 | X | [为什么] |

          ### 护城河5维度评分
          | 维度 | 评分(-2到+2) | 理由 |
          |------|--------------|------|
          | 持久性 | X | [理由] |
          | 可量化 | X | [理由] |
          | 可复制性 | X | [理由] |
          | 定价权 | X | [理由] |
          | 扩展性 | X | [理由] |

          **护城河总分**: X/100
          **护城河强度**: 强/中/弱
          **预计持续年限**: X年

          ### 护城河侵蚀风险
          1. [风险1]: 如果___则护城河受损
          2. [风险2]: 如果___则护城河受损
          3. [风险3]: 如果___则护城河受损

      module_3_product_matrix:
        name: "产品矩阵分析"
        required: true
        output: |
          ## Phase 3.3 产品矩阵分析

          ### 产品节点表
          | 产品/服务 | 角色 | 层级 | 收入占比 | 毛利率 | 增速 |
          |-----------|------|------|----------|--------|------|
          | [产品1] | ENTRY/TRAFFIC/MONETIZE/PROFIT/MOAT | L0-L4 | X% | X% | X% |
          | [产品2] | ... | ... | ... | ... | ... |

          ### 飞轮分析
          **飞轮1**: [名称]
          - 路径: A → B → C → D → A
          - 加速器: [什么让飞轮转更快]
          - 断裂点: [什么会让飞轮停转]
          - KPI: [指标1]=X, [指标2]=X

          **飞轮2**: [名称]
          - 路径: ...

          ### 利润池地图
          | 利润池 | 当前贡献 | 毛利率 | 未来潜力 | 迁移方向 |
          |--------|----------|--------|----------|----------|
          | [池1] | $XB | X% | 扩大/稳定/萎缩 | → |
          | [池2] | $XB | X% | ... | → |

          **利润池迁移**: 从___向___迁移，因为___

      module_4_ai_stack:
        name: "AI产业链分析"
        condition: "行业为半导体/AI/科技"
        required_if_applicable: true
        output: |
          ## Phase 3.4 AI产业链分析

          ### 7层定位
          ```
          Layer 5 AI应用      │ [相关公司] │ 滞后12-18个月
          Layer 4 AI模型      │ [相关公司] │
          Layer 3 云基础设施   │ [相关公司] │
          Layer 2.5 基础设施  │ [相关公司] │ 2026年新瓶颈
          Layer 2 AI芯片      │ [相关公司] │
          Layer 1 芯片制造    │ [相关公司] │
          Layer 0 半导体设备  │ ★[目标公司]│ 领先12-18个月
          ```

          ### 信号传导时间线
          | 事件 | 时间 | 对目标公司影响 | 领先/滞后 |
          |------|------|----------------|-----------|
          | [上游事件] | 202X-XX | [影响] | 领先X月 |
          | [当前事件] | 202X-XX | [影响] | 当前 |
          | [下游事件] | 202X-XX | [影响] | 滞后X月 |

          ### 瓶颈转移分析
          - 2023-2024瓶颈: [描述]
          - 2025-2026瓶颈: [描述]
          - 对目标公司影响: [分析]

          ### 上下游依赖图
          ```
          上游: [供应商1] → [供应商2] → [目标公司]
          下游: [目标公司] → [客户1] → [客户2] → [终端]
          ```

      module_5_core_thesis:
        name: "核心命题深度分析"
        required: true
        output: |
          ## Phase 3.5 核心命题分析

          ### 命题1: [最重要的问题]
          **明确判断**: [结论]
          **但如果**: [反证条件]则不成立

          **证据链**:
          | 证据 | 来源 | 强度 | 支持/反对 |
          |------|------|------|-----------|
          | [证据1] | [来源] | 强/中/弱 | 支持/反对 |
          | [证据2] | [来源] | 强/中/弱 | 支持/反对 |

          **机制分析**（为什么）:
          [深入解释因果机制，达到Level 3+深度]

          **量化影响**:
          | 情景 | 概率 | 对EPS影响 | 对估值影响 |
          |------|------|-----------|-----------|
          | 悲观 | X% | $X | X% |
          | 基准 | X% | $X | X% |
          | 乐观 | X% | $X | X% |

          ### 命题2-5: [同样结构]

      module_6_investor_perspective:
        name: "投资者多视角分析"
        required: true
        output: |
          ## Phase 3.6 投资者多视角

          ### Druckenmiller视角
          | 维度 | 评分(0-100) | 理由 |
          |------|-------------|------|
          | 宏观对齐 | X | [理由] |
          | 护城河 | X | [理由] |
          | 估值 | X | [理由] |
          | 盈利质量 | X | [理由] |
          | 流动性 | X | [理由] |
          | 催化剂 | X | [理由] |
          **综合评分**: X/100
          **Druckenmiller会买?**: 是/否/可能

          ### Buffett视角
          - 能理解这个业务吗? [是/否]
          - 有持久竞争优势吗? [是/否]
          - 管理层诚实能干吗? [是/否]
          - 价格合理吗? [是/否]
          **Buffett会买?**: 是/否

          ### 流动性信号检查
          - Fed政策方向: [宽松/收紧/中性]
          - 债券市场信号: [风险偏好高/低]
          - 信用利差: [收窄/扩大]
          **流动性环境**: 有利/中性/不利

    checkpoint_3:
      name: "Phase 3 检查点"
      must_pass:
        - "层级决策框架已执行(Level 0-4)"
        - "护城河分析已完成(6类+7 Powers+5维度)"
        - "产品矩阵已分析(节点+飞轮+利润池)"
        - "AI产业链已分析(如适用)"
        - "核心命题≥3个，每个有机制分析"
        - "投资者多视角已执行"
        - "每个核心判断有反证句"
      blocking: true
      message: "Phase 3 检查点未通过，不能进入Phase 4"

  # ---------------------------------------------------------------------------
  # Phase 4: 估值与输出
  # ---------------------------------------------------------------------------
  phase_4_valuation_output:
    name: "估值与输出"
    duration: "20分钟"

    mandatory_steps:

      step_1_reverse_dcf:
        action: "执行Reverse DCF提取隐含预期"
        output: |
          ## Phase 4.1 Reverse DCF

          **当前股价**: $X
          **隐含预期**:
          | 假设 | 隐含值 | 合理值 | 差距 |
          |------|--------|--------|------|
          | 收入CAGR | X% | X% | X% |
          | 目标利润率 | X% | X% | X% |
          | CAP(竞争优势期) | X年 | X年 | X年 |
          | 终值增长率 | X% | X% | X% |

          **Expectation Gap**: [正向/负向/中性]
          **解读**: [市场预期过高/过低/合理]

      step_2_forward_valuation:
        action: "执行Forward DCF/SOTP"
        output: |
          ## Phase 4.2 三场景SOTP

          ### 熊市场景 (概率X%)
          | 业务 | 收入 | 利润率 | 倍数 | 估值 |
          |------|------|--------|------|------|
          | [业务1] | $XB | X% | Xx | $XB |
          | [业务2] | $XB | X% | Xx | $XB |
          | 净现金 | - | - | - | $XB |
          | **合计** | - | - | - | **$XB** |
          | **每股** | - | - | - | **$X** |

          ### 基准场景 (概率X%)
          [同样结构]

          ### 牛市场景 (概率X%)
          [同样结构]

          ### 概率加权目标价
          | 场景 | 概率 | 每股价值 | 加权贡献 |
          |------|------|---------|---------|
          | 熊市 | X% | $X | $X |
          | 基准 | X% | $X | $X |
          | 牛市 | X% | $X | $X |
          | **合计** | 100% | - | **$X** |

      step_3_valuation_reconciliation:
        action: "验证估值逻辑自洽"
        output: |
          ## Phase 4.3 估值逻辑自洽检查

          | 检查项 | 数值 | 状态 |
          |--------|------|------|
          | SOTP概率加权 | $X | - |
          | 最终目标价 | $X | - |
          | 差距 | X% | ✅<20% / ❌>20% |

          **如果差距>20%，解释原因**:
          [必须详细解释为什么最终目标价与SOTP不同]

      step_4_kill_switches:
        action: "定义Kill Switches"
        output: |
          ## Phase 4.4 Kill Switches

          | ID | 条件 | 触发阈值 | 行动 | 概率 |
          |----|------|----------|------|------|
          | KS-1 | [条件] | [阈值] | [行动] | X% |
          | KS-2 | [条件] | [阈值] | [行动] | X% |
          | KS-3 | [条件] | [阈值] | [行动] | X% |

      step_5_quality_gate:
        action: "执行质量门控检查"
        output: |
          ## Phase 4.5 质量门控执行结果

          | 检查项 | 状态 | 数值/备注 |
          |--------|------|-----------|
          | 数据来源标注 | ✅/❌ | X% |
          | FMP数据展示 | ✅/❌ | |
          | 100baggers数据展示 | ✅/❌ | |
          | 分析师全景表 | ✅/❌ | X位 |
          | 市场分歧表 | ✅/❌ | X个 |
          | 层级决策框架 | ✅/❌ | Level 0-4 |
          | 护城河分析 | ✅/❌ | 6类+7P+5维 |
          | 产品矩阵分析 | ✅/❌ | 节点+飞轮+利润池 |
          | AI产业链分析 | ✅/❌/N/A | 7层定位 |
          | 核心命题 | ✅/❌ | X个 |
          | 机制分析深度 | ✅/❌ | 平均Level X |
          | 反证句覆盖 | ✅/❌ | X% |
          | Kill Switch | ✅/❌ | X个 |
          | SOTP估值 | ✅/❌ | $X |
          | 目标价逻辑 | ✅/❌ | 与SOTP差距X% |
          | 反常识洞察 | ✅/❌ | X个 |

          **通过项**: X/16
          **总体评估**: 合格/待完善/不合格

      step_6_predictions:
        action: "记录可验证预测"
        output: |
          ## Phase 4.6 可验证预测

          | ID | 预测内容 | 类型 | 置信度 | 校准后 | 验证日期 |
          |----|----------|------|--------|--------|----------|
          | PRED_001 | [预测] | structural/event/timing | X% | X% | 202X-XX |
          | PRED_002 | [预测] | ... | X% | X% | 202X-XX |

    checkpoint_4:
      name: "Phase 4 检查点（最终）"
      must_pass:
        - "Reverse DCF已执行"
        - "SOTP三场景已完成"
        - "SOTP与目标价差距<20%或有详细解释"
        - "Kill Switch≥3个"
        - "质量门控表已填写"
        - "通过项≥14/16"
      blocking: true
      message: "Phase 4 检查点未通过，报告不合格"

# =============================================================================
# 第二部分：阻断式检查点汇总
# =============================================================================

checkpoint_summary:

  phase_1_checkpoint:
    items: 4
    blocking: true
    failure_action: "停止，完成Phase 1后再继续"

  phase_2_checkpoint:
    items: 5
    blocking: true
    failure_action: "停止，完成Phase 2后再继续"

  phase_3_checkpoint:
    items: 7
    blocking: true
    failure_action: "停止，完成Phase 3后再继续"

  phase_4_checkpoint:
    items: 6
    blocking: true
    failure_action: "报告标记为不合格"

  total_checkpoint_items: 22
  pass_threshold: "100% Phase 1-3 + ≥14/16 Phase 4"

# =============================================================================
# 第三部分：快速启动命令
# =============================================================================

quick_start:

  trigger_phrases:
    - "深度调研"
    - "深度分析"
    - "完整报告"
    - "全面分析"

  response_template: |
    ## 深度研究启动

    **目标公司**: [TICKER]
    **执行协议**: deep_research_protocol_v1.yaml
    **预计时间**: 90分钟

    ### 执行计划
    - [ ] Phase 1: 定位与框架选择 (10分钟)
    - [ ] Phase 2: 数据收集与分析师学习 (20分钟)
    - [ ] Phase 3: 深度分析执行 (40分钟)
    - [ ] Phase 4: 估值与输出 (20分钟)

    **开始执行Phase 1...**

# =============================================================================
# 第四部分：与CLAUDE.md集成
# =============================================================================

claude_md_integration:

  add_to_claude_md: |
    ## 深度研究执行协议

    当用户请求"深度调研"、"深度分析"、"完整报告"时：

    1. **必须使用**: skills/_common/deep_research_protocol_v1.yaml
    2. **分4阶段执行**: 每阶段有阻断式检查点
    3. **禁止一次性输出**: 每个Phase完成后验证才能继续
    4. **质量优先于字数**: 按维度完整度评估，非按字数

    检查点未通过 = 停止 + 补充 + 重新验证
